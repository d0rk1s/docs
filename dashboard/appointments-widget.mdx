---
title: "Widget de Pr√≥ximas Citas"
description: "Visualiza y gestiona las citas del d√≠a en tiempo real"
icon: "calendar-days"
---

## ¬øQu√© es el widget de pr√≥ximas citas?

Es una tabla interactiva en el Dashboard que muestra las **pr√≥ximas citas del d√≠a** con detalles clave para operaci√≥n r√°pida.

**Caracter√≠sticas**:
- Muestra solo citas de **hoy** (seg√∫n zona horaria de la cl√≠nica)
- Ordenadas por **hora de inicio** (m√°s pr√≥ximas primero)
- Incluye nombre del paciente, servicio, proveedor, hora y estado
- Acciones r√°pidas: Ver detalles, editar, cancelar

<Note>
El widget se actualiza autom√°ticamente cada 5 minutos junto con las estad√≠sticas generales.
</Note>

<Frame>
  <img src="/images/screenshots/dashboard_appointments_widget.png" alt="Widget de pr√≥ximas citas mostrando tabla con hora, paciente, servicio, proveedor y acciones" />
</Frame>

---

## Columnas de la tabla

### 1. Hora

**Formato**: `HH:MM - HH:MM` (ej: `10:00 - 10:30`)

```
Ejemplo:
- Cita A: 09:00 - 09:45 (Duraci√≥n: 45 minutos)
- Cita B: 10:00 - 10:30 (Duraci√≥n: 30 minutos)
```

**Zona horaria**: Siempre en la zona horaria de la cl√≠nica (`Europe/Madrid` por defecto).

<Tip>
Las horas se alinean con el horario de apertura de la cl√≠nica. Si abre a las 16:00, las citas ser√°n 16:00, 16:30, 17:00 (no 16:35 o 17:05).
</Tip>

---

### 2. Paciente

**Formato**: Nombre completo del paciente (ej: `Manuel L√≥pez S√°nchez`)

**Detalles**:
- Si el paciente existe en el sistema, muestra su nombre registrado
- Si es un paciente nuevo (creado v√≠a WhatsApp), muestra el nombre capturado por el bot
- Clickeable: Al hacer clic, abre el perfil del paciente (en desarrollo)

```
Ejemplo:
- Paciente: "Eduardo Cassanovas Garc√≠a"
- Al hacer clic ‚Üí Abre modal con historial de citas, tel√©fono, notas
```

<Warning>
**Multi-cl√≠nica**: Si un paciente existe en otra cl√≠nica con nombre diferente, el sistema actualiza su nombre cuando agenda en tu cl√≠nica.
</Warning>

---

### 3. Servicio

**Formato**: Nombre del servicio (ej: `Corte de pelo`, `Tinte`)

**Detalles**:
- Muestra el servicio seleccionado al crear la cita
- Incluye duraci√≥n impl√≠cita (no visible, pero determina `end_datetime`)
- Si no hay servicio asignado, muestra `Sin servicio` (raro, pero posible)

```
Ejemplo:
- Servicio: "Corte de pelo"
- Duraci√≥n: 30 minutos (configurada en "Servicios")
- Precio: ‚Ç¨15 (suma a "Ingresos Estimados" cuando se completa)
```

---

### 4. Proveedor

**Formato**: Nombre del proveedor (ej: `Peluquero 1`, `Barbero 2`)

**Detalles**:
- Muestra el proveedor asignado a la cita
- Si la cl√≠nica tiene varios proveedores, ayuda a distribuir carga
- Clickeable: Al hacer clic, filtra citas de ese proveedor (en desarrollo)

<Info>
Si tu cl√≠nica tiene solo un proveedor, esta columna siempre mostrar√° el mismo nombre. √ötil si planeas contratar m√°s personal.
</Info>

---

### 5. Estado

**Valores posibles**:

| Estado | Badge | Significado |
|--------|-------|-------------|
| `CONFIRMED` | üîµ Azul | Cita agendada, esperando a ser completada |
| `COMPLETED` | ‚úÖ Verde | Cita finalizada (paciente atendido) |
| `CANCELLED` | ‚ùå Rojo | Cita cancelada (por usuario o paciente) |

**Transiciones autom√°ticas**:

```
CONFIRMED ‚Üí COMPLETED (cuando pasa la hora de fin)
CONFIRMED ‚Üí CANCELLED (cuando usuario/paciente cancela)
COMPLETED ‚Üí (final, no cambia)
CANCELLED ‚Üí (final, no cambia)
```

<Note>
El cambio de `CONFIRMED` a `COMPLETED` ocurre autom√°ticamente cuando pasa la hora de fin de la cita.
</Note>

---

### 6. Acciones

**Botones disponibles**:

#### Ver Detalles
- **Icono**: üëÅÔ∏è (ojo)
- **Acci√≥n**: Abre modal con informaci√≥n completa de la cita
- **Incluye**: Tel√©fono del paciente, notas, fecha de creaci√≥n, canal (WhatsApp/Web)

#### Editar
- **Icono**: ‚úèÔ∏è (l√°piz)
- **Acci√≥n**: Permite modificar fecha, hora, servicio o proveedor
- **Validaci√≥n**: Verifica disponibilidad del nuevo horario antes de guardar

<Warning>
Editar la hora recalcula la disponibilidad. Si el nuevo slot est√° ocupado, la edici√≥n fallar√°.
</Warning>

#### Cancelar
- **Icono**: üóëÔ∏è (basura)
- **Acci√≥n**: Cambia el estado a `CANCELLED`
- **Confirmaci√≥n**: Muestra di√°logo "¬øEst√°s seguro?" antes de cancelar

**Efectos de cancelar**:
- Libera el horario para nuevas reservas
- Elimina la cita de "Citas Confirmadas" (contador disminuye)
- NO se puede deshacer (la cita queda marcada como cancelada permanentemente)

---

## Ordenamiento y filtros

### Ordenamiento autom√°tico

Las citas se muestran **ordenadas por hora de inicio** (ascendente):

```
Ejemplo:
09:00 - 09:30 (Corte de pelo)
10:00 - 10:45 (Tinte)
11:00 - 11:30 (Manicura)
```

**Citas del pasado (hoy)**:
- Si son las 12:00, las citas de 09:00 y 10:00 se muestran con estado `COMPLETED`
- Permanecen en la tabla hasta la medianoche (√∫til para revisi√≥n del d√≠a)

---

### Filtros disponibles

Actualmente el widget **NO tiene filtros interactivos**. Siempre muestra:
- **Fecha**: Hoy (no se pueden ver citas de otros d√≠as desde el Dashboard)
- **Cl√≠nica**: La seleccionada en el men√∫ superior
- **Estado**: Todos los estados (confirmadas, completadas, canceladas)

<Info>
Para ver citas de otros d√≠as, usa la secci√≥n **"Citas"** en el men√∫ lateral (calendario completo).
</Info>

---

## Actualizaci√≥n en tiempo real

### ¬øC√≥mo se actualiza?

El widget usa el mismo mecanismo de **polling** que las estad√≠sticas:

1. Frontend hace petici√≥n GET `/v1/dashboard/appointments?clinic_id=...` cada 5 minutos
2. Backend consulta PostgreSQL con filtro `DATE(start_datetime) = TODAY`
3. Frontend actualiza la tabla sin refrescar la p√°gina

**Eventos que gatillan actualizaciones**:
- Nueva cita creada v√≠a WhatsApp ‚Üí Aparece en 5 minutos
- Usuario edita una cita ‚Üí Cambios visibles en 5 minutos
- Cita se completa autom√°ticamente ‚Üí Estado cambia en 1-5 minutos

<Tip>
Si necesitas ver cambios instant√°neos (ej: acabas de crear una cita), refresca la p√°gina (F5).
</Tip>

---

## Casos de uso comunes

### Escenario 1: Verificar pr√≥ximas citas al llegar

**Objetivo**: Saber qui√©n viene en las pr√≥ximas horas.

**Pasos**:
1. Abres el Dashboard a las 09:00
2. El widget muestra:
   - 09:30 - Manuel L√≥pez (Corte de pelo)
   - 10:00 - Laura Garc√≠a (Tinte)
   - 11:00 - Pedro Mart√≠nez (Barba)
3. **Acci√≥n**: Preparas los materiales para el tinte de Laura (requiere tiempo de setup)

---

### Escenario 2: Cancelar cita de paciente que no viene

**Objetivo**: Liberar un slot cuando el paciente llama para cancelar.

**Pasos**:
1. Paciente llama a las 10:15: "No puedo ir a mi cita de las 11:00"
2. Abres el Dashboard
3. Buscas la cita de las 11:00 en el widget
4. Haces clic en el bot√≥n üóëÔ∏è (Cancelar)
5. Confirmas la cancelaci√≥n
6. **Resultado**:
   - Estado cambia a `CANCELLED`
   - El horario 11:00 queda disponible para nuevas reservas
   - "Citas Confirmadas" disminuye en 1

<Warning>
La cancelaci√≥n es **permanente**. Si el paciente cambia de opini√≥n, debes crear una nueva cita.
</Warning>

---

### Escenario 3: Editar cita porque paciente llega tarde

**Objetivo**: Mover una cita de 10:00 a 10:30 porque el paciente avisa que llegar√° tarde.

**Pasos**:
1. Paciente env√≠a WhatsApp a las 09:50: "Llegar√© 30 minutos tarde"
2. Abres el Dashboard
3. Encuentras la cita de las 10:00
4. Haces clic en ‚úèÔ∏è (Editar)
5. Cambias la hora a 10:30
6. Sistema valida:
   - ¬øEl slot 10:30 est√° libre? ‚úÖ
   - ¬øEl proveedor est√° disponible? ‚úÖ
   - ¬øLa cl√≠nica est√° abierta? ‚úÖ
7. Guardas los cambios
8. **Resultado**: Cita ahora aparece como 10:30 - 11:00

<Note>
Si el slot 10:30 estaba ocupado, la edici√≥n falla y debes elegir otra hora (ej: 10:45, 11:00).
</Note>

---

### Escenario 4: Ver detalles de un paciente recurrente

**Objetivo**: Recordar preferencias del paciente antes de atenderlo.

**Pasos**:
1. Ves en el widget: `11:00 - Juan P√©rez (Corte de pelo)`
2. Haces clic en üëÅÔ∏è (Ver detalles)
3. El modal muestra:
   - Tel√©fono: +34612345678
   - Notas: "Prefiere corte corto, sin tijera en las patillas"
   - Historial: 5 citas previas (todas completadas)
4. **Acci√≥n**: Preparas la m√°quina de afeitar (no tijera) antes de que llegue

---

## Integraci√≥n con WhatsApp

### Citas creadas por el bot

Cuando un paciente agenda v√≠a WhatsApp:

1. Bot captura: Nombre, fecha, hora, servicio
2. Crea la cita en la base de datos con estado `CONFIRMED`
3. En 5 minutos (m√°ximo), la cita aparece en el widget del Dashboard

**Ejemplo de flujo**:

```
[WhatsApp - 10:15]
Paciente: "Quiero una cita ma√±ana a las 16:00"
Bot: "¬øQu√© servicio necesitas?"
Paciente: "Corte de pelo"
Bot: "Perfecto, ¬øc√≥mo te llamas?"
Paciente: "Carlos Ruiz"
Bot: "‚úÖ Cita agendada para ma√±ana 16:00"

[Dashboard - 10:20]
Widget muestra nueva fila:
- Fecha: Ma√±ana
- 16:00 - 16:30
- Carlos Ruiz
- Corte de pelo
- Peluquero 1
- CONFIRMED
```

---

### Cancelaciones v√≠a WhatsApp

Si el paciente cancela por WhatsApp:

1. Paciente: "Cancela mi cita de las 16:00"
2. Bot pregunta: "¬øQuieres cancelar o reagendar?"
3. Paciente: "Cancelar"
4. Bot ejecuta `cancel_appointment(appointment_id=...)`
5. Estado cambia a `CANCELLED` en la base de datos
6. En 5 minutos, el widget muestra el badge rojo ‚ùå

<Tip>
El bot SIEMPRE pide confirmaci√≥n antes de cancelar. No cancela autom√°ticamente si el mensaje es ambiguo.
</Tip>

---

## Limitaciones actuales

### 1. Solo muestra citas de HOY

**Problema**: No puedes ver citas de ma√±ana o la pr√≥xima semana desde el Dashboard.

**Soluci√≥n**: Usa la secci√≥n **"Citas"** (men√∫ lateral) para ver el calendario completo.

---

### 2. No permite crear citas

**Problema**: El widget solo visualiza, no tiene bot√≥n "Crear nueva cita".

**Soluci√≥n**:
- **V√≠a WhatsApp**: El paciente agenda con el bot
- **Manualmente**: Usa la secci√≥n "Citas" ‚Üí Bot√≥n "Nueva Cita"

---

### 3. No filtra por proveedor

**Problema**: Si tienes 3 peluqueros, no puedes ver solo las citas de "Peluquero 1".

**Soluci√≥n (temporal)**: Usa la columna "Proveedor" para identificar visualmente.

**Mejora futura**: Dropdown para filtrar por proveedor.

---

### 4. No muestra citas pasadas de otros d√≠as

**Problema**: Una vez pasa la medianoche, las citas de ayer desaparecen del widget.

**Soluci√≥n**: Usa reportes hist√≥ricos (en desarrollo) o exporta datos v√≠a API.

---

## Estados especiales y casos raros

### Cita creada pero paciente no vino

**Escenario**: Cita de las 10:00, paciente no apareci√≥, ahora son las 10:45.

**Estado en el sistema**:
- Estado: `COMPLETED` (marcado autom√°ticamente por el job)
- Ingresos estimados: Suma el precio del servicio (‚Ç¨15)
- **Problema**: El ingreso real fue ‚Ç¨0 (paciente no vino)

**Soluci√≥n manual**:
1. Cancela la cita (cambia a `CANCELLED`)
2. Esto elimina el ingreso de "Ingresos Estimados"
3. Opcional: Agrega nota en el perfil del paciente ("No se present√≥ el 15/01/2026")

<Warning>
El sistema NO detecta autom√°ticamente inasistencias. Debes marcarlas manualmente.
</Warning>

---

### Cita con servicio eliminado

**Escenario**: Ten√≠as un servicio "Manicura", creaste citas con ese servicio, luego eliminaste "Manicura" de la lista de servicios.

**Estado en el sistema**:
- La cita sigue existiendo
- Columna "Servicio" muestra: `Servicio eliminado (ID: abc-123)`
- Puedes editar la cita para cambiar a otro servicio

<Info>
El sistema conserva la relaci√≥n `appointment.service_id` incluso si el servicio fue eliminado (integridad referencial con `ON DELETE SET NULL`).
</Info>

---

### Cita con proveedor suspendido

**Escenario**: Proveedor "Peluquero 2" fue suspendido (cambio de personal), pero tiene citas agendadas.

**Estado en el sistema**:
- Cita sigue apareciendo en el widget
- Columna "Proveedor" muestra: `Peluquero 2` (nombre original)
- Puedes reasignar la cita a otro proveedor activo

**Pasos para reasignar**:
1. Haz clic en ‚úèÔ∏è (Editar)
2. Cambia el proveedor a "Peluquero 1"
3. Guarda los cambios
4. Sistema valida que "Peluquero 1" est√© disponible en ese horario

---

## Rendimiento y escalabilidad

### ¬øCu√°ntas citas puede mostrar?

**L√≠mite pr√°ctico**: Hasta 50 citas en el widget sin degradaci√≥n de UX.

**C√°lculo**:
- Cl√≠nica abierta: 10:00 - 20:00 (10 horas)
- Duraci√≥n promedio por cita: 30 minutos
- Citas m√°ximas/d√≠a: 10h √ó 2 citas/h = 20 citas
- Con 3 proveedores: 20 √ó 3 = 60 citas/d√≠a

**Si tienes &gt;50 citas/d√≠a**:
- El widget mostrar√° todas, pero con scroll vertical
- Considera usar filtros por proveedor (cuando est√© disponible)

---

### Impacto en la base de datos

Cada actualizaci√≥n del widget ejecuta esta query:

```sql
SELECT a.id, a.start_datetime, a.end_datetime, a.status,
       u.full_name AS patient_name,
       s.name AS service_name,
       p.name AS provider_name
FROM appointments a
JOIN users u ON a.patient_id = u.id
JOIN services s ON a.service_id = s.id
JOIN providers p ON a.provider_id = p.id
WHERE a.clinic_id = :clinic_id
  AND DATE(a.start_datetime) = CURRENT_DATE
ORDER BY a.start_datetime ASC;
```

**Optimizaci√≥n**:
- √çndice compuesto en `(clinic_id, start_datetime)` ‚Üí query &lt;10ms
- Cache de 5 minutos ‚Üí 12 queries/hora (carga m√≠nima)

<Note>
El sistema soporta **decenas de miles de citas** sin problemas de rendimiento gracias a los √≠ndices.
</Note>

---

## Soluci√≥n de problemas

### Las citas no aparecen en el widget

**Causas posibles**:
1. **Zona horaria incorrecta**: La cita est√° en UTC pero la cl√≠nica en `Europe/Madrid`
   - **Soluci√≥n**: Verifica `CLINIC_DEFAULT_TZ` en configuraci√≥n
2. **Cita creada para otro d√≠a**: El widget solo muestra HOY
   - **Soluci√≥n**: Verifica la fecha en la secci√≥n "Citas"
3. **Estado cancelado**: Las citas canceladas aparecen pero con badge rojo
   - **Soluci√≥n**: Verifica el estado en la columna "Estado"

---

### El estado no cambia de CONFIRMED a COMPLETED

**Soluci√≥n**:
1. Espera unos minutos despu√©s de que termine la hora de la cita
2. Refresca la p√°gina (F5) para ver los cambios
3. Si el problema persiste despu√©s de 5-10 minutos, contacta a soporte t√©cnico

<Warning>
Si las citas no se completan autom√°ticamente por m√°s de 1 hora, contacta a soporte inmediatamente.
</Warning>

---

### Editar cita falla con "Horario no disponible"

**Diagn√≥stico**:
1. Verifica que el nuevo horario est√© dentro de `work_hours` de la cl√≠nica
2. Verifica que el proveedor NO tenga otra cita en ese horario
3. Verifica que NO haya un `closure` (cierre) en esa fecha/hora

**Ejemplo de error**:
```
Error: El proveedor "Peluquero 1" no est√° disponible a las 15:00
Causa: Peluquero 1 solo trabaja de 09:00-13:00 (ma√±anas)
Soluci√≥n: Cambia a las 12:00 o elige otro proveedor
```

---

## Pr√≥ximos pasos

<CardGroup cols={2}>
  <Card title="Estad√≠sticas Generales" icon="chart-line" href="/dashboard/stats-overview">
    Volver a la vista general del Dashboard
  </Card>

  <Card title="Ingresos Detallados" icon="money-bill-wave" href="/dashboard/revenue-tracking">
    Analizar de d√≥nde vienen tus ingresos
  </Card>

  <Card title="Gesti√≥n de Citas" icon="calendar" href="/appointments/overview">
    Ver calendario completo con todas las citas
  </Card>

  <Card title="API de Citas" icon="code" href="/api-reference/dashboard/get-appointments">
    Integrar el widget en tu sistema
  </Card>
</CardGroup>
