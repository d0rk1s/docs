---
title: "Historial de Mensajes"
description: "Revisa el historial completo de una conversaciÃ³n con el bot"
---

# Historial de Mensajes WhatsApp

El historial de mensajes te permite revisar la conversaciÃ³n completa entre un paciente y el bot de WhatsApp, incluyendo:

- Todos los mensajes enviados y recibidos
- Herramientas invocadas por el bot (create_appointment, get_availability, etc.)
- Timestamps precisos de cada mensaje
- Metadatos tÃ©cnicos (IDs, latencia, cache hits)

## Acceder al Historial

### Desde la Lista de Conversaciones

<Steps>
  <Step title="Ve a WhatsApp â†’ Conversaciones">
    Navega a la secciÃ³n **WhatsApp** â†’ **Conversaciones** desde el menÃº lateral.
  </Step>

  <Step title="Encuentra la conversaciÃ³n">
    Usa bÃºsqueda o filtros para encontrar la conversaciÃ³n deseada.
  </Step>

  <Step title="Haz clic en 'Ver'">
    Haz clic en el botÃ³n **"Ver"** o en la fila completa para abrir el historial.
  </Step>
</Steps>

### Vista de Historial

El historial muestra mensajes en orden cronolÃ³gico (mÃ¡s antiguo arriba, mÃ¡s reciente abajo), similar a una conversaciÃ³n de WhatsApp.

<Frame>
  <img src="/images/screenshots/whatsapp_conversation_detail.png" alt="Detalle de conversaciÃ³n WhatsApp mostrando mensajes, herramientas usadas y timestamps" />
</Frame>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Historial de ConversaciÃ³n                                     â”‚
â”‚ Paciente: MarÃ­a GarcÃ­a (+34612345678)                         â”‚
â”‚ Estado: Activa                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  [16/01/2026 14:30:15] Paciente:                              â”‚
â”‚  "Hola, necesito un corte de pelo para maÃ±ana"                â”‚
â”‚                                                                â”‚
â”‚  [16/01/2026 14:30:18] Bot:                                   â”‚
â”‚  "Â¡Hola MarÃ­a! Claro, te muestro disponibilidad para          â”‚
â”‚  corte de pelo maÃ±ana (17 de enero)..."                       â”‚
â”‚  ğŸ”§ Herramienta: get_availability                             â”‚
â”‚  â±ï¸ Latencia: 2.35ms (cache hit)                             â”‚
â”‚                                                                â”‚
â”‚  [16/01/2026 14:31:02] Paciente:                              â”‚
â”‚  "A las 10 estÃ¡ bien"                                         â”‚
â”‚                                                                â”‚
â”‚  [16/01/2026 14:31:05] Bot:                                   â”‚
â”‚  "Perfecto, he agendado tu cita:                              â”‚
â”‚  ğŸ“… Fecha: 17/01/2026 a las 10:00                             â”‚
â”‚  âœ‚ï¸ Servicio: Corte de pelo (30 min)                          â”‚
â”‚  Â¡Te esperamos!"                                               â”‚
â”‚  ğŸ”§ Herramienta: create_appointment                           â”‚
â”‚  â±ï¸ Latencia: 543ms (DB query)                               â”‚
â”‚                                                                â”‚
â”‚  [16/01/2026 14:31:10] Paciente:                              â”‚
â”‚  "Gracias!"                                                    â”‚
â”‚                                                                â”‚
â”‚  [16/01/2026 14:31:11] Bot:                                   â”‚
â”‚  "Â¡De nada! Si necesitas algo mÃ¡s, aquÃ­ estoy ğŸ˜Š"             â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Elementos del Historial

### Mensajes del Paciente

<Card icon="user" color="#6366F1">
Los mensajes del paciente se muestran con:
- **Icono de usuario** a la izquierda
- **Timestamp** preciso (formato: DD/MM/YYYY HH:MM:SS)
- **Texto del mensaje** tal como fue enviado
- **AlineaciÃ³n izquierda** (convenciÃ³n de chat)
</Card>

**Tipos de mensajes soportados**:
- **Texto plano**: Mensajes escritos normalmente
- **Notas de voz**: Se muestra la transcripciÃ³n con icono ğŸ¤
- **Emojis**: Se muestran correctamente (unicode)

### Mensajes del Bot

<Card icon="robot" color="#0D9373">
Los mensajes del bot se muestran con:
- **Icono de robot** a la derecha
- **Timestamp** preciso
- **Texto de respuesta** formateado
- **AlineaciÃ³n derecha** (convenciÃ³n de chat)
- **Metadatos tÃ©cnicos** (ver abajo)
</Card>

### Metadatos TÃ©cnicos

Para mensajes del bot que invocan herramientas, el sistema muestra metadatos expandibles:

<AccordionGroup>
  <Accordion title="ğŸ”§ Herramienta Usada">
    **QuÃ© muestra**: Nombre de la herramienta invocada por el LLM.

    **Ejemplos**:
    - `get_availability` - ConsultÃ³ horarios disponibles
    - `create_appointment` - CreÃ³ una cita nueva
    - `reschedule_appointment` - ModificÃ³ una cita existente
    - `cancel_appointment` - CancelÃ³ una cita
    - `get_patient_appointments` - BuscÃ³ citas del paciente
    - `list_services` - ListÃ³ servicios de la clÃ­nica

    **Para quÃ© sirve**: Entender quÃ© acciÃ³n ejecutÃ³ el bot internamente.
  </Accordion>

  <Accordion title="â±ï¸ Latencia">
    **QuÃ© muestra**: Tiempo que tomÃ³ procesar el mensaje.

    **Valores tÃ­picos**:
    - **2-5ms (cache hit)**: Resultado obtenido desde cache, ultra rÃ¡pido
    - **200-600ms (DB query)**: Query a base de datos, normal
    - **3-5s (LLM call)**: InvocaciÃ³n del modelo de lenguaje, aceptable
    - **>10s**: Latencia alta, posible problema de performance

    **Para quÃ© sirve**: Detectar mensajes lentos que frustran al paciente.
  </Accordion>

  <Accordion title="ğŸ’¾ Cache Status">
    **QuÃ© muestra**: Si el resultado vino de cache o requiriÃ³ query nuevo.

    **Valores**:
    - **Cache HIT**: Resultado cacheado (ahorro de 99% de latencia)
    - **Cache MISS**: RequiriÃ³ query a DB o API
    - **Cache INVALIDATED**: Cache limpiado por cambio de estado

    **Para quÃ© sirve**: Validar que el cache estÃ¡ funcionando correctamente.
  </Accordion>

  <Accordion title="ğŸ”‘ IDs TÃ©cnicos">
    **QuÃ© muestra**: IDs de base de datos para debugging.

    **Campos**:
    - `message_id`: ID Ãºnico del mensaje en DB
    - `conversation_id`: ID de la conversaciÃ³n completa
    - `appointment_id`: ID de la cita creada/modificada (si aplica)
    - `trace_id`: ID de LangSmith para tracing (si LangSmith estÃ¡ activo)

    **Para quÃ© sirve**: Reportar bugs especÃ­ficos a equipo tÃ©cnico con IDs exactos.
  </Accordion>

  <Accordion title="âš ï¸ Errores y Warnings">
    **QuÃ© muestra**: Si hubo errores o advertencias durante el procesamiento.

    **Ejemplos**:
    - `[ERROR] Service not found` - Servicio solicitado no existe
    - `[WARNING] Appointment limit reached` - LÃ­mite de plan alcanzado
    - `[ERROR] Invalid phone format` - NÃºmero de telÃ©fono invÃ¡lido
    - `[WARNING] Hallucination detected` - Audio corto con transcripciÃ³n dudosa

    **Para quÃ© sirve**: Identificar conversaciones con problemas tÃ©cnicos.
  </Accordion>
</AccordionGroup>

## Funcionalidades Interactivas

### Expandir/Contraer Metadatos

Por defecto, los metadatos tÃ©cnicos estÃ¡n contraÃ­dos para no saturar la vista. Puedes:

- **Clic en icono** ğŸ”§ para expandir/contraer metadatos de un mensaje especÃ­fico
- **BotÃ³n "Expandir todos"** para ver metadatos de todos los mensajes
- **BotÃ³n "Contraer todos"** para ocultar todos los metadatos

<Tip>
Usa "Expandir todos" cuando estÃ©s debugging una conversaciÃ³n problemÃ¡tica. Usa vista normal (contraÃ­da) para lectura rÃ¡pida.
</Tip>

### Copiar Texto de Mensaje

Haz clic en el icono de **"copiar"** (ğŸ“‹) junto a cada mensaje para copiar el texto al portapapeles.

**Ãštil para**:
- Reportar bugs con texto exacto
- Compartir conversaciÃ³n con equipo tÃ©cnico
- Documentar casos de uso

### Buscar en Historial

Usa el campo de bÃºsqueda en la parte superior para encontrar mensajes especÃ­ficos:

**Ejemplos de bÃºsqueda**:
- `cancelar` - Encuentra mensajes donde el paciente pidiÃ³ cancelar
- `10:00` - Encuentra menciones de horarios especÃ­ficos
- `corte` - Encuentra menciones del servicio "corte de pelo"
- `create_appointment` - Encuentra mensajes donde el bot creÃ³ una cita

<Note>
La bÃºsqueda es case-insensitive (no distingue mayÃºsculas/minÃºsculas) y busca en texto de mensajes y nombres de herramientas.
</Note>

## Indicadores Visuales

### TranscripciÃ³n de Notas de Voz

Los mensajes de voz transcritos se muestran con formato especial:

```
[16/01/2026 15:45:20] Paciente:
ğŸ¤ Nota de voz (4.2 segundos):
"Hola necesito una cita para maÃ±ana a las diez"

TranscripciÃ³n: OpenAI Whisper
Latencia: 5.3s (2.1s transcripciÃ³n + 3.2s procesamiento)
```

**Elementos**:
- **Icono ğŸ¤**: Indica que fue nota de voz, no texto escrito
- **DuraciÃ³n**: Segundos de audio
- **Texto transcrito**: Lo que Whisper entendiÃ³ del audio
- **Metadatos**: Servicio usado (Whisper) y latencia desglosada

### Mensajes con Errores

Los mensajes donde el bot fallÃ³ se muestran con banner rojo:

```
[16/01/2026 16:10:33] Bot:
âš ï¸ ERROR: No pude procesar tu mensaje
"Lo siento, hubo un problema tÃ©cnico. Por favor intenta de nuevo o contacta a la clÃ­nica."

ğŸ”§ Error: ServiceNotFoundError
Detalle: Service "tinte de cejas" not found in database
Sugerencia: Verifica que el servicio exista en catÃ¡logo
```

**QuÃ© hacer**:
1. Lee el detalle del error
2. Sigue la sugerencia (si aplica)
3. Reporta a equipo tÃ©cnico con `message_id` si no puedes resolver

## Casos de Uso Comunes

### Validar que el Bot AgendÃ³ Correctamente

**Objetivo**: Verificar que una cita fue creada con datos correctos.

<Steps>
  <Step title="Abre el historial">
    Desde la lista de conversaciones, haz clic en "Ver" para la conversaciÃ³n deseada.
  </Step>

  <Step title="Busca 'create_appointment'">
    Usa la bÃºsqueda para encontrar mensajes con herramienta `create_appointment`.
  </Step>

  <Step title="Expande metadatos">
    Haz clic en ğŸ”§ para ver parÃ¡metros enviados a la herramienta.
  </Step>

  <Step title="Verifica datos">
    Confirma que:
    - Fecha y hora son correctas
    - Servicio es el solicitado por el paciente
    - TelÃ©fono estÃ¡ en formato E.164 correcto (+34612345678)
    - Nombre del paciente es correcto
  </Step>

  <Step title="Valida en calendario">
    Ve al calendario de citas para confirmar que la cita existe en el sistema.
  </Step>
</Steps>

### Debugging de ConversaciÃ³n ProblemÃ¡tica

**Objetivo**: Identificar por quÃ© el bot no pudo ayudar al paciente.

<Steps>
  <Step title="Identifica sÃ­ntomas">
    Â¿QuÃ© indica que hay problema?
    - Paciente repite la misma pregunta 3+ veces
    - Bot invoca la misma herramienta mÃºltiples veces sin Ã©xito
    - ConversaciÃ³n tiene 15+ mensajes sin resolver
    - Paciente usa palabras como "error", "no funciona", "no entiendo"
  </Step>

  <Step title="Expande todos los metadatos">
    Haz clic en "Expandir todos" para ver detalles tÃ©cnicos completos.
  </Step>

  <Step title="Busca errores">
    Revisa mensajes con banner rojo (âš ï¸ ERROR).
  </Step>

  <Step title="Analiza herramientas">
    Â¿QuÃ© herramientas se invocaron?
    - Si `get_availability` se llamÃ³ 5+ veces â†’ problema con detecciÃ³n de disponibilidad
    - Si `create_appointment` fallÃ³ â†’ problema con validaciÃ³n de datos
    - Si `search_patient` fallÃ³ â†’ problema con formato de telÃ©fono
  </Step>

  <Step title="Verifica parÃ¡metros">
    Expande metadatos de herramientas fallidas para ver quÃ© parÃ¡metros se enviaron.

    **Problemas comunes**:
    - Fecha en formato incorrecto (debe ser YYYY-MM-DD)
    - TelÃ©fono sin formato E.164 (+34...)
    - Service ID incorrecto (no existe en DB)
  </Step>

  <Step title="Reporta con IDs">
    Copia `message_id`, `conversation_id`, y `trace_id` (si LangSmith estÃ¡ activo) para reportar al equipo tÃ©cnico.
  </Step>
</Steps>

### Analizar Performance del Bot

**Objetivo**: Identificar mensajes lentos que frustran al paciente.

<Steps>
  <Step title="Filtra por latencia alta">
    Busca mensajes con â±ï¸ Latencia > 10s.
  </Step>

  <Step title="Identifica patrÃ³n">
    Â¿La latencia alta es sistemÃ¡tica o aislada?
    - **SistemÃ¡tica**: Problema de infraestructura (DB lenta, API de OpenAI lenta)
    - **Aislada**: Problema con herramienta especÃ­fica o query compleja
  </Step>

  <Step title="Revisa cache status">
    Â¿Los resultados vienen de cache o requieren queries?
    - **Cache HIT frecuente**: Sistema optimizado âœ“
    - **Cache MISS frecuente**: Cache no estÃ¡ funcionando, problema de TTL
  </Step>

  <Step title="Analiza herramientas lentas">
    Â¿QuÃ© herramientas toman mÃ¡s tiempo?
    - `get_availability` deberÃ­a ser 2-5ms (cache) o 200-400ms (DB)
    - `create_appointment` deberÃ­a ser 400-600ms
    - Si toma &gt;1s â†’ problema de query o Ã­ndices faltantes
  </Step>

  <Step title="Reporta performance issues">
    Reporta a equipo tÃ©cnico con:
    - `message_id` del mensaje lento
    - Latencia observada
    - Herramienta invocada
    - Cache status (HIT o MISS)
  </Step>
</Steps>

## Exportar Historial

### Copiar ConversaciÃ³n Completa

Haz clic en el botÃ³n **"Copiar todo"** en la parte superior para copiar el historial completo al portapapeles.

**Formato**:
```
ConversaciÃ³n con MarÃ­a GarcÃ­a (+34612345678)
Estado: Activa
Fecha: 16/01/2026 - 17/01/2026

[16/01/2026 14:30:15] Paciente:
Hola, necesito un corte de pelo para maÃ±ana

[16/01/2026 14:30:18] Bot:
Â¡Hola MarÃ­a! Claro, te muestro disponibilidad...
[Herramienta: get_availability]

...
```

**Ãštil para**:
- Compartir con equipo tÃ©cnico
- Documentar casos de uso
- Reportar bugs con contexto completo

### Descargar como JSON (TÃ©cnico)

Haz clic en **"Descargar JSON"** para obtener el historial en formato JSON con todos los metadatos tÃ©cnicos.

**Formato**:
```json
{
  "conversation_id": "conv_abc123",
  "patient": {
    "name": "MarÃ­a GarcÃ­a",
    "phone": "+34612345678"
  },
  "messages": [
    {
      "message_id": "msg_xyz789",
      "timestamp": "2026-01-16T14:30:15Z",
      "role": "user",
      "content": "Hola, necesito un corte de pelo para maÃ±ana"
    },
    {
      "message_id": "msg_abc456",
      "timestamp": "2026-01-16T14:30:18Z",
      "role": "assistant",
      "content": "Â¡Hola MarÃ­a! Claro...",
      "tool_calls": [
        {
          "tool": "get_availability",
          "latency_ms": 2.35,
          "cache_status": "HIT"
        }
      ]
    }
  ]
}
```

**Ãštil para**:
- AnÃ¡lisis tÃ©cnico profundo
- Import a herramientas de anÃ¡lisis (LangSmith, etc.)
- Debugging avanzado

## Mejores PrÃ¡cticas

<Tip>
**Revisa conversaciones finalizadas**: Aunque parezca que todo saliÃ³ bien, revisa conversaciones finalizadas para encontrar patrones de mejora.
</Tip>

<Tip>
**Usa bÃºsqueda para auditar**: Busca palabras clave como "cancelar", "error", "no entiendo" para identificar conversaciones problemÃ¡ticas rÃ¡pidamente.
</Tip>

<Warning>
**No modifiques el historial**: El historial es read-only para preservar integridad de auditorÃ­a. Solo staff tÃ©cnico puede modificar datos.
</Warning>

## Troubleshooting

### No veo metadatos tÃ©cnicos

**Causa**: Los metadatos estÃ¡n contraÃ­dos por defecto.

**SoluciÃ³n**: Haz clic en el icono ğŸ”§ junto al mensaje o en "Expandir todos".

### Mensaje aparece como "[Contenido no disponible]"

**Causas posibles**:
1. **Mensaje eliminado**: El paciente eliminÃ³ el mensaje en WhatsApp antes de que llegara al servidor
2. **Formato no soportado**: El paciente enviÃ³ un formato de mensaje que el sistema no procesa (video, imagen, documento)
3. **Error de sincronizaciÃ³n**: Problema temporal con Twilio webhook

**SoluciÃ³n**: Si se repite, reporta a equipo tÃ©cnico con `conversation_id`.

### Latencia muy alta (>30s)

**Causas comunes**:
1. **API de OpenAI saturada**: Picos de trÃ¡fico en OpenAI
2. **Base de datos lenta**: Queries complejas sin Ã­ndices
3. **Timeout de cache**: Cache expirÃ³ y requiere query completa

**QuÃ© hacer**:
1. Verifica si es problema aislado o sistemÃ¡tico (revisa otras conversaciones)
2. Si es sistemÃ¡tico, contacta a equipo tÃ©cnico
3. Si es aislado, simplemente reintenta la acciÃ³n

## PrÃ³ximos Pasos

<CardGroup cols={2}>
  <Card title="Pausar el Bot" icon="pause" href="/whatsapp/pause-bot">
    Aprende a pausar el bot cuando detectes problemas
  </Card>
  <Card title="Enviar Mensaje Manual" icon="paper-plane" href="/whatsapp/send-manual-message">
    Toma control manualmente para responder como staff
  </Card>
</CardGroup>
