---
title: "Ver Plan Actual"
description: "Cómo consultar la suscripción activa, límites, uso y configuración de overage de una clínica"
icon: "eye"
---

## Introducción

Este tutorial explica cómo consultar la suscripción actual de una clínica, incluyendo plan activo, límites de citas, uso en el período actual, y configuración de overage.

## Endpoint REST API

### GET /v1/subscription

Devuelve la suscripción completa de la clínica autenticada.

**Autenticación**: Requiere token JWT válido (cookie `access_token`).

**Query Parameters**:
- `clinic_id` (UUID, required): ID de la clínica

**Response Schema** (`SubscriptionResponse`):
```json
{
  "id": "uuid",
  "clinic_id": "uuid",
  "plan_id": "uuid",
  "plan_name": "STARTER",
  "plan_display_name": "Starter Plan",
  "appointment_limit": 50,
  "price_monthly": 29.0,
  "overage_rate": 0.35,
  "allow_overage": true,
  "billing_period_start": "2026-01-01T00:00:00Z",
  "billing_period_end": "2026-02-01T00:00:00Z",
  "appointments_billed": 35,
  "conversations_count": 12,
  "status": "active",
  "stripe_customer_id": "cus_...",
  "stripe_subscription_id": "sub_...",
  "created_at": "2025-12-01T10:00:00Z",
  "updated_at": "2026-01-15T08:30:00Z"
}
```

<Frame>
  <img src="/images/screenshots/subscription_current_plan.png" alt="Interfaz de visualización del plan actual con detalles de suscripción y uso" />
</Frame>

## Ejemplo de Uso

### cURL

```bash
curl -X GET "https://api.sonrisafeliz.com/v1/subscription?clinic_id=abc-123-def-456" \
  -H "Cookie: access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Accept: application/json"
```

### Python

```python
import httpx
from uuid import UUID

async def get_current_subscription(clinic_id: UUID, access_token: str):
    """
    Obtiene la suscripción actual de una clínica.

    Args:
        clinic_id: UUID de la clínica
        access_token: Token JWT de autenticación

    Returns:
        dict: Datos completos de la suscripción
    """
    async with httpx.AsyncClient() as client:
        response = await client.get(
            "https://api.sonrisafeliz.com/v1/subscription",
            params={"clinic_id": str(clinic_id)},
            cookies={"access_token": access_token},
        )
        response.raise_for_status()
        return response.json()

# Ejemplo de uso
subscription = await get_current_subscription(
    clinic_id=UUID("abc-123-def-456"),
    access_token="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
)

print(f"Plan: {subscription['plan_name']}")
print(f"Citas usadas: {subscription['appointments_billed']}/{subscription['appointment_limit']}")
print(f"Overage habilitado: {subscription['allow_overage']}")
```

### JavaScript/TypeScript

```typescript
interface SubscriptionResponse {
  id: string;
  clinic_id: string;
  plan_id: string;
  plan_name: string;
  plan_display_name: string;
  appointment_limit: number;
  price_monthly: number;
  overage_rate: number;
  allow_overage: boolean;
  billing_period_start: string;
  billing_period_end: string;
  appointments_billed: number;
  conversations_count: number;
  status: string;
  stripe_customer_id: string | null;
  stripe_subscription_id: string | null;
  created_at: string;
  updated_at: string;
}

async function getCurrentSubscription(
  clinicId: string,
  accessToken: string
): Promise<SubscriptionResponse> {
  const response = await fetch(
    `https://api.sonrisafeliz.com/v1/subscription?clinic_id=${clinicId}`,
    {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Accept': 'application/json',
        'Cookie': `access_token=${accessToken}`,
      },
    }
  );

  if (!response.ok) {
    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
  }

  return response.json();
}

// Ejemplo de uso
const subscription = await getCurrentSubscription(
  'abc-123-def-456',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
);

console.log(`Plan: ${subscription.plan_name}`);
console.log(`Citas: ${subscription.appointments_billed}/${subscription.appointment_limit}`);
console.log(`Overage: ${subscription.allow_overage ? 'Sí' : 'No'}`);
```

## Interpretación de Campos

### Campos del Plan

| Campo | Tipo | Descripción |
|-------|------|-------------|
| `plan_name` | string | Nombre técnico del plan (FREE, STARTER, PRO, BUSINESS, ENTERPRISE) |
| `plan_display_name` | string | Nombre para mostrar al usuario |
| `appointment_limit` | integer | Límite de citas mensuales del plan |
| `price_monthly` | float | Precio mensual en euros |
| `overage_rate` | float | Precio por cita extra cuando overage habilitado |

### Campos de Configuración

| Campo | Tipo | Descripción |
|-------|------|-------------|
| `allow_overage` | boolean | Si el overage está habilitado para esta clínica |
| `billing_period_start` | datetime | Inicio del período de facturación actual (UTC) |
| `billing_period_end` | datetime | Fin del período de facturación actual (UTC) |

### Campos de Uso

| Campo | Tipo | Descripción |
|-------|------|-------------|
| `appointments_billed` | integer | Citas creadas en el período actual |
| `conversations_count` | integer | Conversaciones de WhatsApp en el período |

### Campos de Stripe

| Campo | Tipo | Descripción |
|-------|------|-------------|
| `stripe_customer_id` | string \| null | ID del cliente en Stripe |
| `stripe_subscription_id` | string \| null | ID de la suscripción en Stripe (null si FREE) |

<Warning>
  **Invariante**: Si `stripe_subscription_id` es `null`, el `plan_name` DEBE ser `FREE`. Esta invariante es aplicada a nivel de aplicación.
</Warning>

## Acceso desde el Modelo

Si trabajas directamente con SQLAlchemy, puedes acceder a la suscripción usando el modelo `ClinicSubscription`:

```python
from sqlalchemy import select
from sqlalchemy.orm import selectinload
from app.models import ClinicSubscription

# Cargar suscripción CON plan (evita N+1 queries)
query = (
    select(ClinicSubscription)
    .where(ClinicSubscription.clinic_id == clinic_id)
    .options(selectinload(ClinicSubscription.plan))
)
subscription = (await db.execute(query)).scalar_one()

# Propiedades que leen desde el plan relacionado
print(subscription.appointment_limit)     # → subscription.plan.appointment_limit
print(subscription.overage_rate)          # → subscription.plan.overage_rate
print(subscription.plan_name)             # → subscription.plan.plan_name
print(subscription.plan_display_name)     # → subscription.plan.display_name
print(subscription.price_monthly)         # → subscription.plan.price_monthly

# Columna directa en clinic_subscription
print(subscription.allow_overage)         # Boolean - preferencia del admin

# Acceso directo al plan
print(subscription.plan.description)
print(subscription.plan.is_active)
print(subscription.plan.is_custom)
```

<Tip>
  **Eager Loading**: Usa `selectinload(ClinicSubscription.plan)` para evitar N+1 queries. Esto carga el plan en la misma consulta.
</Tip>

## Servicio de Suscripciones

El sistema incluye `SubscriptionService` para operaciones comunes:

```python
from app.services.subscription_service import SubscriptionService

service = SubscriptionService(db)

# Verificar límite de citas
limit_check = await service.check_appointment_limit(clinic_id)

if limit_check["over_limit"]:
    print(f"⚠️ Límite excedido: {limit_check['current_count']}/{limit_check['limit']}")
    if limit_check["overage_allowed"]:
        print(f"Overage habilitado - Cargo adicional: €{limit_check['overage_cost']}")
    else:
        print("Overage NO habilitado - No se permiten más citas")
else:
    remaining = limit_check["limit"] - limit_check["current_count"]
    print(f"✅ {remaining} citas disponibles este mes")
```

## Servicio de Planes

Para trabajar con el catálogo de planes:

```python
from app.services.plan_service import PlanService

plan_service = PlanService(db)

# Listar todos los planes activos
plans = await plan_service.list_all_plans()
for plan in plans:
    print(f"{plan.display_name}: {plan.appointment_limit} citas/mes - €{plan.price_monthly}")

# Obtener plan específico
starter_plan = await plan_service.get_plan_by_name("STARTER")
print(f"STARTER: {starter_plan.appointment_limit} citas, overage €{starter_plan.overage_rate}/cita")
```

## Casos de Uso Comunes

### 1. Mostrar Dashboard de Suscripción

```python
async def render_subscription_dashboard(clinic_id: UUID, db: AsyncSession):
    """Renderiza dashboard con info de suscripción."""
    service = SubscriptionService(db)
    subscription = await service.get_subscription_for_clinic(clinic_id)

    # Calcular días restantes en período
    now = datetime.now(timezone.utc)
    days_remaining = (subscription.billing_period_end - now).days

    # Calcular progreso de uso
    usage_percent = (subscription.appointments_billed / subscription.appointment_limit) * 100

    return {
        "plan": subscription.plan_display_name,
        "appointments_used": subscription.appointments_billed,
        "appointments_limit": subscription.appointment_limit,
        "usage_percent": usage_percent,
        "days_remaining": days_remaining,
        "next_billing_date": subscription.billing_period_end,
        "overage_enabled": subscription.allow_overage,
        "monthly_cost": subscription.price_monthly,
    }
```

### 2. Verificar si Puede Crear Cita

```python
async def can_create_appointment(clinic_id: UUID, db: AsyncSession) -> tuple[bool, str]:
    """
    Verifica si la clínica puede crear una nueva cita.

    Returns:
        tuple[bool, str]: (permitido, mensaje)
    """
    service = SubscriptionService(db)
    limit_check = await service.check_appointment_limit(clinic_id)

    if not limit_check["over_limit"]:
        return True, "OK"

    if limit_check["overage_allowed"]:
        overage_cost = limit_check["overage_cost"]
        return True, f"Overage activo - Cargo adicional: €{overage_cost:.2f}"

    return False, f"Límite alcanzado ({limit_check['limit']} citas/mes). Upgrade tu plan."
```

### 3. Calcular Costo Estimado del Mes

```python
async def calculate_monthly_cost(clinic_id: UUID, db: AsyncSession) -> dict:
    """Calcula el costo estimado del mes actual."""
    service = SubscriptionService(db)
    subscription = await service.get_subscription_for_clinic(clinic_id)

    base_cost = subscription.price_monthly
    overage_count = max(0, subscription.appointments_billed - subscription.appointment_limit)
    overage_cost = overage_count * subscription.overage_rate if subscription.allow_overage else 0
    total_cost = base_cost + overage_cost

    return {
        "base_cost": base_cost,
        "overage_appointments": overage_count,
        "overage_cost": overage_cost,
        "total_cost": total_cost,
    }
```

## Errores Comunes

### 404 Not Found

```json
{
  "detail": "No subscription found for clinic"
}
```

**Causa**: La clínica no tiene suscripción configurada.

**Solución**: Ejecutar script de setup:
```bash
python scripts/setup_subscriptions.py --batch --plan FREE --yes
```

### 403 Forbidden

```json
{
  "detail": "No access to clinic abc-123-def-456"
}
```

**Causa**: El usuario autenticado no tiene acceso a la clínica especificada.

**Solución**: Verificar que el `clinic_id` en el token JWT coincide con el `clinic_id` del query parameter.

## Próximos Pasos

<CardGroup cols={2}>
  <Card title="Upgrade de Plan" icon="arrow-trend-up" href="/subscription/upgrade-plan">
    Mejora el plan de tu clínica con Stripe Checkout
  </Card>
  <Card title="Monitoreo de Uso" icon="chart-line" href="/subscription/usage-monitoring">
    Consulta uso detallado y límites
  </Card>
  <Card title="Downgrade de Plan" icon="arrow-trend-down" href="/subscription/downgrade-plan">
    Reduce tu plan con Subscription Schedules
  </Card>
  <Card title="Visión General" icon="arrow-left" href="/subscription/overview">
    Volver a la visión general
  </Card>
</CardGroup>
