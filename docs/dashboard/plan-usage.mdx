---
title: "Uso del Plan de Suscripci√≥n"
description: "Monitorea tu consumo y optimiza tu plan de facturaci√≥n"
icon: "chart-pie"
---

## ¬øQu√© es el uso del plan?

El Dashboard muestra cu√°ntas citas has consumido de tu l√≠mite mensual de suscripci√≥n.

**F√≥rmula**:
```
Uso del Plan = (Citas creadas en per√≠odo actual / L√≠mite del plan) √ó 100%
```

**Ejemplo**:
```
Plan: STARTER (50 citas/mes)
Per√≠odo: 01/01/2026 - 31/01/2026
Citas creadas: 35
Uso del Plan: 35 / 50 = 70%
```

<Note>
El porcentaje se actualiza cada 5 minutos junto con las estad√≠sticas del Dashboard.
</Note>

<Frame>
  <img src="/images/screenshots/dashboard_plan_usage_widget.png" alt="Widget de uso del plan mostrando porcentaje consumido y l√≠mite mensual" />
</Frame>

---

## Planes disponibles

### Tabla de planes est√°ndar

| Plan | Citas/mes | Precio/mes | Overage | Descripci√≥n |
|------|-----------|------------|---------|-------------|
| **FREE** | 10 | ‚Ç¨0 | NO | Plan de prueba gratuito |
| **STARTER** | 50 | ‚Ç¨29 | ‚Ç¨0.35/cita | Para cl√≠nicas peque√±as |
| **PRO** | 200 | ‚Ç¨99 | ‚Ç¨0.30/cita | Para cl√≠nicas medianas |
| **BUSINESS** | 500 | ‚Ç¨199 | ‚Ç¨0.25/cita | Para cl√≠nicas grandes |
| **ENTERPRISE** | Ilimitado | ‚Ç¨499 | NO | Plan ilimitado |

<Info>
Los precios son orientativos. Consulta tu configuraci√≥n espec√≠fica en "Configuraci√≥n ‚Üí Suscripci√≥n".
</Info>

---

### Planes personalizados (ENTERPRISE_CUSTOM)

Para empresas con necesidades espec√≠ficas, puedes crear planes customizados:

**Ejemplo**:
```
Plan: ENTERPRISE_CUSTOM_HOSPITAL_X
Citas/mes: 300
Precio/mes: ‚Ç¨350
Overage: ‚Ç¨0.20/cita
```

**Cu√°ndo usarlo**:
- Necesitas l√≠mite espec√≠fico (ej: 300 citas, ni 200 ni 500)
- Negociaste tarifa especial con ventas
- Tienes contrato enterprise con SLA personalizado

<Tip>
Solo administradores del sistema pueden crear planes customizados. Contacta a soporte si necesitas uno.
</Tip>

---

## ¬øQu√© cuenta como cita facturada?

### Regla principal

**Solo citas CREADAS en el per√≠odo actual**:
- ‚úÖ Citas creadas entre `billing_period_start` y `billing_period_end`
- ‚ùå Citas creadas ANTES del per√≠odo (aunque se atiendan hoy)

**Ejemplo**:
```
Per√≠odo actual: 01/02/2026 - 28/02/2026

Cita A:
- Creada: 28/01/2026 (enero)
- Atendida: 03/02/2026 (febrero)
- ¬øCuenta? ‚ùå NO (creada en enero)

Cita B:
- Creada: 05/02/2026 (febrero)
- Atendida: 10/02/2026 (febrero)
- ¬øCuenta? ‚úÖ S√ç (creada en febrero)
```

---

### Estados de citas

| Estado | ¬øCuenta para facturaci√≥n? | Raz√≥n |
|--------|--------------------------|-------|
| `CONFIRMED` | ‚úÖ S√ç | Cita agendada, consumi√≥ un slot |
| `COMPLETED` | ‚úÖ S√ç | Cita atendida, servicio prestado |
| `CANCELLED` | ‚úÖ S√ç | Cita consumi√≥ slot aunque se cancel√≥ |

<Warning>
**IMPORTANTE**: Las citas canceladas S√ç cuentan para facturaci√≥n. Esto evita que usuarios abusen cancelando/creando citas repetidamente.
</Warning>

**Ejemplo**:
```
Citas del per√≠odo:
1. Cita A ‚Üí CONFIRMED (cuenta)
2. Cita B ‚Üí COMPLETED (cuenta)
3. Cita C ‚Üí CANCELLED (cuenta)

Total facturado: 3 citas
```

---

## Per√≠odo de facturaci√≥n

### ¬øCu√°ndo inicia y termina?

**Para planes pagados** (STARTER, PRO, BUSINESS):
- Inicio: Fecha de contrataci√≥n en Stripe
- Fin: Inicio + 1 mes (billing_cycle_anchor)
- Renovaci√≥n: Autom√°tica cada mes

**Ejemplo**:
```
Contrataste STARTER el 15/01/2026 a las 14:30

Per√≠odo 1: 15/01/2026 14:30 - 15/02/2026 14:30
Per√≠odo 2: 15/02/2026 14:30 - 15/03/2026 14:30
Per√≠odo 3: 15/03/2026 14:30 - 15/04/2026 14:30
```

**Para plan FREE**:
- Inicio: Cuando asignamos el plan FREE
- Fin: Inicio + 30 d√≠as
- Renovaci√≥n: Autom√°tica (sin cobro)

---

### Reset del contador

Al inicio de cada per√≠odo:
1. `appointments_billed` se resetea a 0
2. `billing_period_start` avanza 1 mes
3. `billing_period_end` avanza 1 mes
4. Uso del Plan = 0%

**Ejemplo**:
```
Per√≠odo anterior (enero):
- Citas creadas: 45 / 50 (90%)
- Factura: ‚Ç¨29 (plan STARTER)

Per√≠odo nuevo (febrero):
- 01/02/2026 00:00 ‚Üí Reset autom√°tico
- Citas creadas: 0 / 50 (0%)
- Contador vuelve a cero ‚úÖ
```

<Note>
El reset NO lo hace el backend de la cl√≠nica. Stripe env√≠a un webhook `invoice.paid` que actualiza el per√≠odo.
</Note>

---

## Overage (exceso de citas)

### ¬øQu√© es?

Cuando superas el l√≠mite del plan, tienes dos opciones:
1. **Sin overage**: No puedes crear m√°s citas (bloqueado)
2. **Con overage**: Puedes seguir creando citas (se cobra el excedente)

**Configuraci√≥n**:
- **Campo**: `clinic_subscriptions.allow_overage` (TRUE o FALSE)
- **Control**: Administrador de la cl√≠nica (p√°gina de suscripci√≥n)

---

### C√°lculo del cargo por overage

**F√≥rmula**:
```
Cargo por overage = (Citas creadas - L√≠mite) √ó Tarifa overage
```

**Ejemplo**:
```
Plan: STARTER (50 citas/mes, tarifa overage ‚Ç¨0.35/cita)
Citas creadas en enero: 55
Excedente: 55 - 50 = 5 citas
Cargo por overage: 5 √ó ‚Ç¨0.35 = ‚Ç¨1.75

Factura de enero:
- Plan STARTER: ‚Ç¨29.00
- Overage (5 citas): ‚Ç¨1.75
- TOTAL: ‚Ç¨30.75
```

---

### Tarifas de overage por plan

| Plan | L√≠mite | Tarifa overage | Ejemplo (10 citas extra) |
|------|--------|---------------|--------------------------|
| FREE | 10 | NO disponible | ‚ùå Bloqueado |
| STARTER | 50 | ‚Ç¨0.35/cita | ‚Ç¨3.50 |
| PRO | 200 | ‚Ç¨0.30/cita | ‚Ç¨3.00 |
| BUSINESS | 500 | ‚Ç¨0.25/cita | ‚Ç¨2.50 |
| ENTERPRISE | ‚àû | NO aplica | ‚Ç¨0 (ilimitado) |

<Warning>
El plan FREE NO permite overage. Si llegas a 10 citas, el sistema bloquea creaci√≥n de nuevas citas.
</Warning>

---

### Activar/desactivar overage

**Desde el panel**:
1. Ve a "Configuraci√≥n ‚Üí Suscripci√≥n"
2. Busca la opci√≥n "Permitir exceso de citas (overage)"
3. Activa/desactiva el toggle
4. Guarda cambios

**Desde la API**:
```bash
curl -X PATCH "https://api.clinica.com/v1/subscription/overage" \
  -H "Authorization: Bearer {token}" \
  -d '{"allow_overage": true}'
```

**Efecto inmediato**:
- Si activas overage ‚Üí Puedes crear citas aunque superes el l√≠mite
- Si desactivas overage ‚Üí Sistema bloquea creaci√≥n de citas al llegar al l√≠mite

<Tip>
Recomendaci√≥n: Activa overage si no est√°s seguro de cu√°ntas citas tendr√°s al mes. Es mejor pagar ‚Ç¨2-3 extra que perder clientes por bloqueo.
</Tip>

---

## Estados visuales en el Dashboard

### C√≥digo de colores

El Dashboard muestra el porcentaje de uso con colores:

| Rango | Color | Badge | Significado |
|-------|-------|-------|-------------|
| 0% - 70% | Verde | `‚úÖ Uso normal` | Lejos del l√≠mite, sin riesgo |
| 70% - 90% | Amarillo | `‚ö†Ô∏è Acerc√°ndose` | Planifica upgrade o activa overage |
| 90% - 100% | Naranja | `‚ö†Ô∏è L√≠mite cercano` | Quedan pocas citas disponibles |
| > 100% | Rojo | `‚ùå L√≠mite excedido` | En overage (solo si est√° habilitado) |

**Ejemplo visual**:

```
Plan STARTER (50 citas):

35 / 50 (70%) ‚Üí Badge verde ‚úÖ "Uso normal"
45 / 50 (90%) ‚Üí Badge amarillo ‚ö†Ô∏è "Acerc√°ndose al l√≠mite"
50 / 50 (100%) ‚Üí Badge naranja ‚ö†Ô∏è "L√≠mite alcanzado"
55 / 50 (110%) ‚Üí Badge rojo ‚ùå "L√≠mite excedido (+5 overage)"
```

---

### Alertas autom√°ticas (en desarrollo)

**Funcionalidades planificadas**:
- üìß **Email al 80% de uso**: "Has consumido 40 de 50 citas este mes"
- üì± **WhatsApp al 90% de uso**: "Te quedan 5 citas disponibles"
- üîî **Notificaci√≥n in-app al 100%**: "L√≠mite alcanzado, activa overage o haz upgrade"

<Info>
Actualmente las alertas NO est√°n implementadas. Debes revisar el Dashboard manualmente.
</Info>

---

## Casos de uso comunes

### Escenario 1: Plan FREE (10 citas) - Control estricto

**Objetivo**: No superar el l√≠mite del plan gratuito.

**Pasos**:
1. Inicias el mes: 0 / 10 (0%)
2. Primera semana: 3 / 10 (30%)
3. Segunda semana: 6 / 10 (60%)
4. Tercera semana: 9 / 10 (90%) ‚ö†Ô∏è Badge amarillo
5. **Acci√≥n**: Decides no agendar m√°s citas este mes
6. Cuarta semana: Esperas al pr√≥ximo per√≠odo (reset el d√≠a 1)

**Alternativa**:
- Hacer upgrade a STARTER (‚Ç¨29/mes, 50 citas)
- Beneficio: 40 citas m√°s + capacidad de crecer

---

### Escenario 2: Plan STARTER (50 citas) - Overage activado

**Objetivo**: Aceptar todas las citas aunque superes el l√≠mite.

**Pasos**:
1. Inicias enero: 0 / 50 (0%)
2. Mitad de mes: 30 / 50 (60%)
3. Semana 3: 45 / 50 (90%) ‚ö†Ô∏è
4. Semana 4: 52 / 50 (104%) ‚ùå Overage activado
5. **Sistema**: Permite crear citas extras (no bloquea)
6. Fin de mes: 55 / 50 (110%)
7. **Factura**:
   - Plan STARTER: ‚Ç¨29.00
   - Overage (5 citas): ‚Ç¨1.75
   - TOTAL: ‚Ç¨30.75

**Ventaja**:
- No pierdes clientes por l√≠mite
- Solo pagas ‚Ç¨1.75 extra por 5 citas (‚Ç¨0.35/cita)

---

### Escenario 3: Plan PRO (200 citas) - Subutilizaci√≥n

**Objetivo**: Optimizar costos si no usas todas las citas.

**Pasos**:
1. Enero: 80 / 200 (40%)
2. Febrero: 75 / 200 (37.5%)
3. Marzo: 85 / 200 (42.5%)
4. **An√°lisis**: Promedio de 80 citas/mes
5. **Problema**: Pagas ‚Ç¨99/mes por un plan de 200, solo usas 80 (40%)
6. **Acci√≥n**: Downgrade a STARTER (50 citas/mes, ‚Ç¨29/mes)
7. **Nuevo escenario con overage**:
   - Plan STARTER: ‚Ç¨29.00
   - Overage (30 citas): ‚Ç¨10.50 (30 √ó ‚Ç¨0.35)
   - TOTAL: ‚Ç¨39.50/mes (ahorro de ‚Ç¨59.50/mes)

<Tip>
**Regla de oro**: Si usas &lt;70% del plan durante 3 meses consecutivos, considera hacer downgrade + activar overage.
</Tip>

---

### Escenario 4: Plan BUSINESS (500 citas) - Expansi√≥n r√°pida

**Objetivo**: Escalar sin preocuparte por l√≠mites.

**Pasos**:
1. Enero: 150 / 500 (30%)
2. Contratas un segundo peluquero
3. Febrero: 280 / 500 (56%)
4. Contratas un tercer peluquero
5. Marzo: 420 / 500 (84%)
6. Abril: 490 / 500 (98%) ‚ö†Ô∏è Acerc√°ndose al l√≠mite
7. **Acci√≥n**: Upgrade a ENTERPRISE (ilimitado, ‚Ç¨499/mes)
8. **Beneficio**: Escalas sin riesgo de bloqueo

**An√°lisis financiero**:
```
Plan BUSINESS (‚Ç¨199/mes):
- 500 citas ‚Üí ‚Ç¨0.40/cita

Plan ENTERPRISE (‚Ç¨499/mes):
- 600 citas ‚Üí ‚Ç¨0.83/cita
- 800 citas ‚Üí ‚Ç¨0.62/cita
- 1000 citas ‚Üí ‚Ç¨0.50/cita

Break-even: 500 citas
Conclusi√≥n: Upgrade rentable si superas 500 citas/mes
```

---

## Gesti√≥n de plan

### Ver detalles del plan actual

**Desde el Dashboard**:
- Widget "Uso del Plan" muestra: `45 / 50 (90%)`
- Tooltip: "Plan STARTER - ‚Ç¨29/mes - Overage: ‚Ç¨0.35/cita"

**Desde Configuraci√≥n**:
1. Ve a "Configuraci√≥n ‚Üí Suscripci√≥n"
2. Ver√°s:
   - Plan actual: STARTER
   - L√≠mite: 50 citas/mes
   - Precio: ‚Ç¨29/mes
   - Per√≠odo: 15/01/2026 - 15/02/2026
   - Citas consumidas: 45
   - Overage activado: ‚úÖ S√ç

---

### Hacer upgrade

**Proceso**:
1. Ve a "Configuraci√≥n ‚Üí Suscripci√≥n"
2. Haz clic en "Cambiar plan"
3. Selecciona plan superior (ej: PRO)
4. Sistema muestra preview:
   ```
   Plan actual: STARTER (‚Ç¨29/mes, 50 citas)
   Plan nuevo: PRO (‚Ç¨99/mes, 200 citas)

   Cambio efectivo: INMEDIATO
   Cargo prorrateado: ‚Ç¨XX (d√≠as restantes del per√≠odo)
   Pr√≥xima factura: ‚Ç¨99 (01/02/2026)
   ```
5. Confirmas el upgrade
6. **Efecto**:
   - L√≠mite cambia de 50 ‚Üí 200 citas inmediatamente
   - Citas consumidas NO se resetean (mantienes 45)
   - Uso del Plan: 45 / 200 (22.5%) ‚úÖ

<Note>
El upgrade es **inmediato**. No necesitas esperar al pr√≥ximo per√≠odo.
</Note>

---

### Hacer downgrade

**Proceso**:
1. Ve a "Configuraci√≥n ‚Üí Suscripci√≥n"
2. Haz clic en "Cambiar plan"
3. Selecciona plan inferior (ej: STARTER)
4. Sistema muestra preview:
   ```
   Plan actual: PRO (‚Ç¨99/mes, 200 citas)
   Plan nuevo: STARTER (‚Ç¨29/mes, 50 citas)

   Cambio efectivo: FIN del per√≠odo actual (15/02/2026)
   Pr√≥xima factura: ‚Ç¨29 (15/02/2026)
   ```
5. Confirmas el downgrade
6. **Efecto**:
   - Downgrade se AGENDA (Stripe Subscription Schedule)
   - Sigues usando PRO hasta fin de per√≠odo
   - El 15/02/2026, el sistema cambia autom√°ticamente a STARTER

<Warning>
**IMPORTANTE**: El downgrade NO es inmediato. Se aplica al final del per√≠odo actual para evitar p√©rdida de servicio.
</Warning>

---

### Cancelar suscripci√≥n

**Proceso**:
1. Ve a "Configuraci√≥n ‚Üí Suscripci√≥n"
2. Haz clic en "Cancelar suscripci√≥n"
3. Sistema muestra advertencia:
   ```
   ‚ö†Ô∏è Al cancelar:
   - Tu plan cambiar√° a FREE (10 citas/mes)
   - Pierdes acceso a funcionalidades premium
   - Historial y datos se conservan
   ```
4. Confirmas la cancelaci√≥n
5. **Efecto**:
   - Plan cambia a FREE inmediatamente
   - L√≠mite: 200 ‚Üí 10 citas
   - Citas consumidas: Se mantienen (ej: 45)
   - Uso del Plan: 45 / 10 (450%) ‚ùå Excedido

<Warning>
Si cancelas y tienes m√°s citas consumidas que el l√≠mite del plan FREE, NO puedes crear nuevas citas hasta el pr√≥ximo per√≠odo.
</Warning>

---

## Integraci√≥n con Stripe

### Webhooks de facturaci√≥n

El sistema recibe eventos de Stripe:

**1. `checkout.session.completed`** (nueva suscripci√≥n o upgrade):
```python
# Backend actualiza:
subscription.plan_id = nuevo_plan_id
subscription.stripe_subscription_id = stripe_sub_id
subscription.billing_period_start = stripe_sub.current_period_start
subscription.billing_period_end = stripe_sub.current_period_end
subscription.appointments_billed = 0  # Reset
```

---

**2. `invoice.paid`** (renovaci√≥n mensual):
```python
# Backend actualiza:
subscription.billing_period_start = stripe_sub.current_period_start
subscription.billing_period_end = stripe_sub.current_period_end
subscription.appointments_billed = 0  # Reset autom√°tico
subscription.status = 'ACTIVE'
```

---

**3. `subscription_schedule.completed`** (downgrade aplicado):
```python
# Backend actualiza:
subscription.plan_id = nuevo_plan_id_downgraded
subscription.billing_period_start = stripe_sub.current_period_start
subscription.billing_period_end = stripe_sub.current_period_end
subscription.appointments_billed = 0  # Reset
```

---

**4. `customer.subscription.deleted`** (cancelaci√≥n):
```python
# Backend actualiza:
subscription.plan_id = FREE_PLAN_ID
subscription.stripe_subscription_id = None  # Desvincula Stripe
subscription.status = 'ACTIVE'  # Sigue activo con FREE
# NO resetea billing_period_end (sirve de "anchor" para FREE)
```

<Info>
Los webhooks son autom√°ticos. No necesitas intervenir manualmente. Si falla un webhook, Stripe reintenta hasta 3 d√≠as.
</Info>

---

## Soluci√≥n de problemas

### "Uso del Plan" muestra m√°s de 100% pero no tengo overage

**Diagn√≥stico**:
1. Verifica configuraci√≥n de overage:
   ```sql
   SELECT allow_overage FROM clinic_subscriptions WHERE clinic_id = 'abc-123';
   ```
2. Si `allow_overage = FALSE`, es un error
3. **Causas posibles**:
   - Webhook de Stripe fall√≥ (no actualiz√≥ configuraci√≥n)
   - Configuraci√≥n manual incorrecta

**Soluci√≥n**:
1. Activa overage manualmente en "Configuraci√≥n ‚Üí Suscripci√≥n"
2. O downgrade a FREE (si quieres bloquear citas)

---

### El contador no se resetea al inicio del mes

**Diagn√≥stico**:
1. Verifica webhooks de Stripe:
   ```bash
   curl -H "Authorization: Bearer {stripe_key}" \
     "https://api.stripe.com/v1/events?type=invoice.paid&limit=10"
   ```
2. Busca evento reciente con `subscription_id` de tu cl√≠nica
3. Si NO existe, Stripe no envi√≥ el webhook

**Causas**:
- Pago fall√≥ (tarjeta expirada, fondos insuficientes)
- Webhook endpoint ca√≠do (verifica logs del servidor)

**Soluci√≥n temporal**:
```bash
# Reset manual via script
python scripts/verify_and_clean_subscriptions.py --clinic-id abc-123 --reset-billing-period
```

---

### Factura de Stripe no coincide con el Dashboard

**Ejemplo**:
```
Dashboard: 55 citas (110% de 50)
Factura Stripe: ‚Ç¨29 (sin overage)
```

**Diagn√≥stico**:
1. Verifica fecha de factura vs per√≠odo actual
2. El Dashboard muestra per√≠odo actual, Stripe factura per√≠odo ANTERIOR

**Ejemplo de timeline**:
```
15/01/2026 - 15/02/2026 (Per√≠odo 1):
- Citas creadas: 55
- Factura generada el 15/02/2026: ‚Ç¨29 + ‚Ç¨1.75 overage = ‚Ç¨30.75

15/02/2026 - 15/03/2026 (Per√≠odo 2):
- Citas creadas hasta hoy (20/02): 10
- Dashboard muestra: 10 / 50 (20%)
- Stripe A√öN NO factura (facturar√° el 15/03)
```

<Tip>
El Dashboard siempre muestra el **per√≠odo ACTUAL**. Stripe factura el **per√≠odo ANTERIOR** al renovar.
</Tip>

---

## Pr√≥ximos pasos

<CardGroup cols={2}>
  <Card title="Estad√≠sticas Generales" icon="chart-line" href="/dashboard/stats-overview">
    Volver a la vista general del Dashboard
  </Card>

  <Card title="Gesti√≥n de Suscripci√≥n" icon="credit-card" href="/subscription/overview">
    Ver detalles completos de tu plan
  </Card>

  <Card title="Stripe Integration" icon="stripe" href="/integrations/stripe">
    Entender la integraci√≥n con Stripe
  </Card>

  <Card title="API de Suscripci√≥n" icon="code" href="/api-reference/subscription/get-subscription">
    Integrar datos de suscripci√≥n en tu sistema
  </Card>
</CardGroup>
