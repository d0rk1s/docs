---
title: "Seguimiento de Ingresos"
description: "Analiza tus ingresos estimados y optimiza tu facturaci√≥n"
icon: "money-bill-wave"
---

## ¬øQu√© son los ingresos estimados?

El Dashboard muestra una **proyecci√≥n** de los ingresos del d√≠a basada en:
- Precio de los servicios agendados
- Citas completadas (no confirmadas)
- NO son pagos reales ni transacciones bancarias

```
F√≥rmula:
Ingresos Estimados = Œ£ (Precio del servicio √ó Citas completadas)
```

<Warning>
**IMPORTANTE**: Este NO es un sistema de cobros. Solo suma precios de servicios. No refleja:
- Descuentos aplicados
- Pagos parciales o adelantos
- Inasistencias (si el cliente no vino, el ingreso real es ‚Ç¨0)
</Warning>

<Frame>
  <img src="/images/screenshots/dashboard_revenue_tracking.png" alt="Visualizaci√≥n de ingresos estimados con desglose por servicio y totales diarios" />
</Frame>

---

## ¬øC√≥mo se calculan?

### Paso 1: Filtrar citas completadas

El sistema busca todas las citas con:
- `clinic_id = tu_clinica`
- `DATE(start_datetime) = HOY`
- `status = COMPLETED`

```sql
SELECT service_id, COUNT(*) as count
FROM appointments
WHERE clinic_id = :clinic_id
  AND DATE(start_datetime) = CURRENT_DATE
  AND status = 'COMPLETED'
GROUP BY service_id;
```

---

### Paso 2: Multiplicar por precio del servicio

Para cada servicio, obtiene el precio de la tabla `services`:

```sql
SELECT s.name, s.price_eur, COUNT(a.id) as num_citas
FROM appointments a
JOIN services s ON a.service_id = s.id
WHERE a.clinic_id = :clinic_id
  AND DATE(a.start_datetime) = CURRENT_DATE
  AND a.status = 'COMPLETED'
GROUP BY s.id, s.name, s.price_eur;
```

**Resultado ejemplo**:

| Servicio | Precio | Citas | Subtotal |
|----------|--------|-------|----------|
| Corte de pelo | ‚Ç¨15 | 8 | ‚Ç¨120 |
| Tinte | ‚Ç¨45 | 2 | ‚Ç¨90 |
| Barba | ‚Ç¨10 | 5 | ‚Ç¨50 |
| **TOTAL** | | **15** | **‚Ç¨260** |

---

### Paso 3: Sumar todos los subtotales

```python
ingresos_estimados = sum(servicio.precio * servicio.num_citas)
# ‚Ç¨260 en el ejemplo anterior
```

<Note>
El c√°lculo se ejecuta cada vez que se actualiza el Dashboard (cada 5 minutos).
</Note>

---

## Estados de citas y facturaci√≥n

### ¬øQu√© citas cuentan?

| Estado | Cuenta para ingresos? | Raz√≥n |
|--------|----------------------|-------|
| `CONFIRMED` | ‚ùå NO | A√∫n no se complet√≥, puede cancelarse |
| `COMPLETED` | ‚úÖ S√ç | Servicio ya prestado |
| `CANCELLED` | ‚ùå NO | Cita cancelada, no hubo ingreso |

**Ejemplo**:

```
Citas del d√≠a:
1. 09:00 - Corte (‚Ç¨15) ‚Üí COMPLETED ‚úÖ ‚Üí Cuenta
2. 10:00 - Tinte (‚Ç¨45) ‚Üí CONFIRMED ‚ùå ‚Üí NO cuenta (a√∫n no termina)
3. 11:00 - Barba (‚Ç¨10) ‚Üí CANCELLED ‚ùå ‚Üí NO cuenta (cancelada)
4. 12:00 - Corte (‚Ç¨15) ‚Üí COMPLETED ‚úÖ ‚Üí Cuenta

Ingresos Estimados = ‚Ç¨15 + ‚Ç¨15 = ‚Ç¨30
```

---

### Transici√≥n autom√°tica a COMPLETED

El sistema marca citas como `COMPLETED` cada 60 segundos:

```python
# Job del scheduler (app/scheduler.py)
@scheduler.scheduled_job('interval', seconds=60, id='complete_appointments')
async def complete_appointments():
    # Busca citas cuyo end_datetime ya pas√≥
    now = datetime.now(timezone.utc)
    overdue_appointments = await db.execute(
        select(Appointment)
        .where(Appointment.status == 'CONFIRMED')
        .where(Appointment.end_datetime < now)
    )
    # Cambia estado a COMPLETED
    for appt in overdue_appointments:
        appt.status = 'COMPLETED'
```

**Ejemplo de transici√≥n**:

```
Cita: 10:00 - 10:30 (Corte de pelo - ‚Ç¨15)

10:25 ‚Üí Estado: CONFIRMED, Ingresos: ‚Ç¨X
10:30 ‚Üí Estado: CONFIRMED, Ingresos: ‚Ç¨X (a√∫n no pas√≥ 1 minuto)
10:31 ‚Üí Estado: COMPLETED, Ingresos: ‚Ç¨X + ‚Ç¨15 ‚úÖ (job ejecutado)
```

<Tip>
Si una cita se complet√≥ pero el Dashboard no la refleja, espera hasta 1 minuto. El job se ejecuta cada 60 segundos.
</Tip>

---

## Desglose por servicio

### Vista detallada (en desarrollo)

Actualmente el Dashboard muestra solo el **total agregado** (ej: ‚Ç¨260).

**Mejora futura**: Tabla de desglose por servicio:

| Servicio | Citas | Precio Unitario | Subtotal |
|----------|-------|----------------|----------|
| Corte de pelo | 8 | ‚Ç¨15 | ‚Ç¨120 |
| Tinte | 2 | ‚Ç¨45 | ‚Ç¨90 |
| Barba | 5 | ‚Ç¨10 | ‚Ç¨50 |
| **TOTAL** | **15** | | **‚Ç¨260** |

<Info>
¬øNecesitas este desglose ahora? Usa la API `/v1/dashboard/stats` y procesa el JSON manualmente.
</Info>

---

## Comparaci√≥n con ingresos reales

### Escenario 1: Inasistencias (no-shows)

**Problema**: Cita se marca como `COMPLETED` pero el paciente no vino.

**Ejemplo**:
```
Cita: 10:00 - 10:30 (Corte - ‚Ç¨15)
10:31 ‚Üí Estado: COMPLETED (autom√°tico)
Ingresos estimados: +‚Ç¨15
Ingreso real: ‚Ç¨0 (paciente no apareci√≥)
```

**Soluci√≥n**:
1. Cancelar manualmente la cita (cambia a `CANCELLED`)
2. Esto elimina los ‚Ç¨15 de "Ingresos Estimados"
3. Opcional: Agregar nota en perfil del paciente

<Warning>
El sistema NO detecta autom√°ticamente inasistencias. Debes marcarlas manualmente para corregir los ingresos.
</Warning>

---

### Escenario 2: Descuentos o promociones

**Problema**: Aplicaste descuento del 20% pero el sistema suma precio completo.

**Ejemplo**:
```
Servicio: Tinte (‚Ç¨45)
Descuento: 20% ‚Üí Precio real: ‚Ç¨36
Ingresos estimados: ‚Ç¨45 ‚ùå (incorrecto)
Ingreso real: ‚Ç¨36 ‚úÖ
```

**Soluci√≥n**:
1. **Opci√≥n A (recomendada)**: Crear servicio temporal "Tinte con descuento" (‚Ç¨36)
2. **Opci√≥n B**: Registrar descuentos manualmente en hoja de c√°lculo externa
3. **Opci√≥n C**: Esperar integraci√≥n con sistema de cobros (Stripe, TPV)

<Info>
Los descuentos NO est√°n implementados en el sistema. Si los aplicas frecuentemente, considera crear servicios duplicados con diferentes precios.
</Info>

---

### Escenario 3: Pagos parciales o adelantos

**Problema**: Cliente pag√≥ ‚Ç¨20 de adelanto para un tinte de ‚Ç¨45.

**Ejemplo**:
```
Servicio: Tinte (‚Ç¨45)
Adelanto: ‚Ç¨20 (pagado hoy)
Pendiente: ‚Ç¨25 (pagar√°s en la cita)

Ingresos estimados: ‚Ç¨45 (cuando se complete la cita)
Ingreso real hoy: ‚Ç¨20 (adelanto)
```

**Soluci√≥n**:
- El sistema NO gestiona adelantos
- Debes llevar registro manual (ej: Excel, cuaderno)
- Los "Ingresos Estimados" reflejan el precio total (‚Ç¨45), no el adelanto (‚Ç¨20)

---

## Casos de uso comunes

### Escenario 1: Proyectar facturaci√≥n del d√≠a

**Objetivo**: Al iniciar el d√≠a, estimar cu√°nto facturar√°s.

**Pasos**:
1. Abre el Dashboard a las 09:00
2. Revisa "Citas Confirmadas": 18 citas
3. Calcula precio promedio: ‚Ç¨15 (mayor√≠a son cortes de pelo)
4. **Proyecci√≥n**: 18 citas √ó ‚Ç¨15 = ‚Ç¨270 estimados
5. A lo largo del d√≠a, las citas se completan autom√°ticamente
6. A las 20:00, revisas: "Ingresos Estimados": ‚Ç¨245
7. **An√°lisis**: Facturaste ‚Ç¨25 menos de lo esperado (1 inasistencia + 1 cancelaci√≥n)

---

### Escenario 2: Identificar servicios m√°s rentables

**Objetivo**: Saber qu√© servicios generan m√°s ingresos.

**Pasos**:
1. Exporta datos del Dashboard usando la API:
   ```bash
   curl -H "Authorization: Bearer {token}" \
     "https://api.clinica.com/v1/dashboard/stats?clinic_id={id}"
   ```
2. Procesa el JSON para agrupar por servicio
3. **Resultado**:
   - Corte de pelo: 8 citas √ó ‚Ç¨15 = ‚Ç¨120 (46%)
   - Tinte: 2 citas √ó ‚Ç¨45 = ‚Ç¨90 (35%)
   - Barba: 5 citas √ó ‚Ç¨10 = ‚Ç¨50 (19%)
4. **Conclusi√≥n**: Los cortes generan m√°s volumen, pero los tintes tienen mejor margen
5. **Acci√≥n**: Promocionas los tintes en redes sociales para aumentar demanda

---

### Escenario 3: Comparar ingresos entre d√≠as

**Objetivo**: Identificar d√≠as de mayor/menor facturaci√≥n.

**Pasos**:
1. Lunes: Dashboard muestra ‚Ç¨320 estimados
2. Martes: ‚Ç¨180 estimados
3. Mi√©rcoles: ‚Ç¨450 estimados
4. **Conclusi√≥n**: Los mi√©rcoles son tu d√≠a m√°s rentable
5. **Acci√≥n**:
   - Planificas promociones para los martes (d√≠a lento)
   - Evitas cerrar los mi√©rcoles (d√≠a pico)

<Note>
Para an√°lisis hist√≥rico robusto, necesitas exportar datos a Excel o implementar reportes (funcionalidad futura).
</Note>

---

## Optimizaci√≥n de ingresos

### Estrategia 1: Aumentar ticket promedio

**Objetivo**: Subir el ingreso por cita de ‚Ç¨15 a ‚Ç¨20.

**T√°cticas**:
1. **Upselling**: Ofrecer servicios complementarios
   - Corte de pelo (‚Ç¨15) + Barba (‚Ç¨10) = ‚Ç¨25
2. **Paquetes**: Crear combos con descuento
   - "Corte + Barba + Ceja" = ‚Ç¨30 (ahorro de ‚Ç¨5 vs precio individual)
3. **Servicios premium**: A√±adir opciones m√°s caras
   - Corte b√°sico (‚Ç¨15) vs Corte + tratamiento capilar (‚Ç¨25)

**Impacto**:
```
Antes: 15 citas/d√≠a √ó ‚Ç¨15 = ‚Ç¨225
Despu√©s: 15 citas/d√≠a √ó ‚Ç¨20 = ‚Ç¨300
Incremento: +‚Ç¨75/d√≠a = +‚Ç¨2,250/mes (30 d√≠as)
```

---

### Estrategia 2: Aumentar volumen de citas

**Objetivo**: Pasar de 15 citas/d√≠a a 20 citas/d√≠a.

**T√°cticas**:
1. **Reducir duraci√≥n de servicios**: Optimizar procesos para atender m√°s r√°pido
   - Corte actual: 30 min ‚Üí Corte optimizado: 20 min
   - Capacidad: 20 citas/d√≠a (10h √ó 60min / 20min = 30 slots, asumiendo 66% ocupaci√≥n)
2. **Contratar m√°s personal**: A√±adir un segundo peluquero
   - Capacidad: 15 citas √ó 2 peluqueros = 30 citas/d√≠a
3. **Ampliar horario**: Abrir 1 hora m√°s temprano o cerrar 1 hora m√°s tarde
   - Horario actual: 10:00-20:00 (10h)
   - Horario ampliado: 09:00-21:00 (12h) ‚Üí +20% capacidad

**Impacto**:
```
Antes: 15 citas/d√≠a √ó ‚Ç¨15 = ‚Ç¨225
Despu√©s: 20 citas/d√≠a √ó ‚Ç¨15 = ‚Ç¨300
Incremento: +‚Ç¨75/d√≠a = +‚Ç¨2,250/mes
```

---

### Estrategia 3: Reducir inasistencias

**Objetivo**: Reducir no-shows del 10% al 5%.

**T√°cticas**:
1. **Recordatorios autom√°ticos**: WhatsApp 24h antes de la cita
   - Implementado: Sistema env√≠a recordatorios (job del scheduler)
2. **Confirmaci√≥n obligatoria**: Pedir confirmaci√≥n 2h antes
   - "Confirma con S√ç para mantener tu cita de las 15:00"
3. **Pol√≠tica de adelantos**: Cobrar ‚Ç¨5 al agendar (descontado del total)
   - Ejemplo: Cita de ‚Ç¨15 ‚Üí Adelanto ‚Ç¨5 ‚Üí Pago final ‚Ç¨10
   - Reduce inasistencias porque el cliente ya pag√≥ algo

**Impacto**:
```
Citas/d√≠a: 15
No-shows antes: 10% ‚Üí 1.5 citas perdidas √ó ‚Ç¨15 = ‚Ç¨22.50/d√≠a
No-shows despu√©s: 5% ‚Üí 0.75 citas perdidas √ó ‚Ç¨15 = ‚Ç¨11.25/d√≠a
Ahorro: +‚Ç¨11.25/d√≠a = +‚Ç¨337/mes
```

---

## Integraci√≥n con sistemas de cobros

### Problema actual

El Dashboard muestra "ingresos estimados" pero NO rastrea:
- ¬øEl cliente pag√≥ en efectivo, tarjeta o Bizum?
- ¬øPag√≥ el total o parcial?
- ¬øDej√≥ propina?

**Para control financiero real, necesitas**:
- Sistema de TPV (Terminal Punto de Venta)
- Stripe / PayPal para pagos online
- Software de contabilidad (ej: Holded, Sage)

---

### Integraci√≥n futura con Stripe

**Flujo propuesto**:
1. Cita se completa ‚Üí Estado: `COMPLETED`
2. Sistema genera "Payment Intent" en Stripe (‚Ç¨15 para el corte)
3. Cliente paga con tarjeta en el local (TPV f√≠sico o link de pago)
4. Stripe confirma el pago ‚Üí Webhook actualiza cita con `payment_status: PAID`
5. Dashboard muestra:
   - Ingresos estimados: ‚Ç¨15 (basado en servicio)
   - Ingresos confirmados: ‚Ç¨15 (basado en pago real)

**Beneficios**:
- Reconciliaci√≥n autom√°tica (ingresos estimados vs reales)
- Tracking de inasistencias (citas completadas pero no pagadas)
- Reportes financieros exportables

<Info>
Esta integraci√≥n est√° en el roadmap pero no implementada. Si la necesitas, contacta a soporte para planificar desarrollo.
</Info>

---

## Reportes hist√≥ricos

### Exportar datos v√≠a API

Para analizar ingresos de per√≠odos m√°s largos (semana, mes, a√±o), usa la API:

**Endpoint**: `GET /v1/dashboard/stats?clinic_id={id}&start_date={date}&end_date={date}`

**Ejemplo**:
```bash
curl -H "Authorization: Bearer {token}" \
  "https://api.clinica.com/v1/dashboard/stats?clinic_id=abc-123&start_date=2026-01-01&end_date=2026-01-31"
```

**Respuesta**:
```json
{
  "total_appointments": 450,
  "completed_appointments": 420,
  "cancelled_appointments": 30,
  "estimated_revenue": 6750.00,
  "breakdown_by_service": [
    {"service": "Corte de pelo", "count": 300, "revenue": 4500.00},
    {"service": "Tinte", "count": 60, "revenue": 2700.00},
    {"service": "Barba", "count": 60, "revenue": 600.00}
  ]
}
```

**Procesamiento**:
1. Descarga el JSON
2. Imp√≥rtalo a Excel / Google Sheets
3. Crea gr√°ficos de tendencia (l√≠nea de tiempo de ingresos)

---

### Reportes autom√°ticos (en desarrollo)

**Funcionalidades planificadas**:
- üìä **Dashboard de reportes**: Vista dedicada con gr√°ficos
- üìÖ **Filtros por rango de fechas**: Semana, mes, trimestre, a√±o
- üìà **Gr√°fico de tendencia**: L√≠nea de tiempo de ingresos diarios
- üìä **Desglose por servicio**: Pie chart de distribuci√≥n de ingresos
- üìä **Desglose por proveedor**: Comparar productividad de peluqueros
- üìÑ **Exportar a PDF/Excel**: Descarga reportes para contabilidad

<Note>
¬øNecesitas reportes avanzados urgentemente? Usa la API para extraer datos crudos y proc√©salos en Excel.
</Note>

---

## Soluci√≥n de problemas

### Ingresos estimados no coinciden con registros manuales

**Diagn√≥stico**:
1. **Verifica estados de citas**: Solo `COMPLETED` cuentan
   ```bash
   # Consulta manual a la DB
   SELECT status, COUNT(*)
   FROM appointments
   WHERE clinic_id = 'abc-123'
     AND DATE(start_datetime) = '2026-01-17'
   GROUP BY status;
   ```
2. **Verifica precios de servicios**: Aseg√∫rate de que coincidan
   ```bash
   SELECT name, price_eur FROM services WHERE clinic_id = 'abc-123';
   ```
3. **Verifica zona horaria**: La fecha "hoy" depende de `CLINIC_DEFAULT_TZ`

---

### Ingresos estimados no aumentan aunque completo citas

**Causas posibles**:
1. **Job del scheduler no corre**: Las citas no se marcan como `COMPLETED`
   ```bash
   curl http://localhost:8000/system/scheduler/status
   # Verifica que "complete_appointments" est√© activo
   ```
2. **Cita sin servicio asignado**: Si `service_id IS NULL`, el precio es ‚Ç¨0
   ```sql
   SELECT COUNT(*) FROM appointments
   WHERE service_id IS NULL
     AND status = 'COMPLETED'
     AND DATE(start_datetime) = CURRENT_DATE;
   ```
3. **Cache del Dashboard**: Espera 5 minutos para actualizaci√≥n autom√°tica

---

### Ingresos estimados est√°n inflados

**Causas posibles**:
1. **Citas de inasistencias no canceladas**: Marcadas como `COMPLETED` pero cliente no vino
   - **Soluci√≥n**: Cancela manualmente las citas (cambia a `CANCELLED`)
2. **Precios incorrectos en servicios**: Servicio tiene precio ‚Ç¨45 pero deber√≠a ser ‚Ç¨30
   - **Soluci√≥n**: Actualiza el precio en "Servicios" (NO afecta citas ya creadas)
3. **Citas duplicadas**: Error al crear cita (ej: doble clic en bot√≥n "Crear")
   - **Soluci√≥n**: Elimina duplicados manualmente

<Warning>
Cambiar el precio de un servicio NO afecta citas ya creadas. La relaci√≥n `appointment.service_id` apunta a `services.price_eur` en el momento del c√°lculo.
</Warning>

---

## Pr√≥ximos pasos

<CardGroup cols={2}>
  <Card title="Estad√≠sticas Generales" icon="chart-line" href="/dashboard/stats-overview">
    Volver a la vista general del Dashboard
  </Card>

  <Card title="Widget de Citas" icon="calendar-days" href="/dashboard/appointments-widget">
    Ver las pr√≥ximas citas del d√≠a en detalle
  </Card>

  <Card title="Gesti√≥n de Servicios" icon="scissors" href="/services/overview">
    Actualizar precios de servicios
  </Card>

  <Card title="API de Dashboard" icon="code" href="/api-reference/dashboard/get-stats">
    Integrar las estad√≠sticas en tu sistema
  </Card>
</CardGroup>
