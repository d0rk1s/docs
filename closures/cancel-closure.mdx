---
title: "Cancelar Cierre"
description: "Gu√≠a paso a paso para eliminar cierres existentes y liberar disponibilidad"
---

# Cancelar Cierre

Esta gu√≠a te ense√±ar√° a cancelar (eliminar) un cierre existente cuando ya no sea necesario. Al cancelar un cierre, los slots bloqueados se liberan inmediatamente y vuelven a estar disponibles para agendar citas.

<Warning>
**Cancelaci√≥n es irreversible**: Una vez cancelado, el cierre se elimina permanentemente de la base de datos. No podr√°s recuperarlo. Si necesitas modificar fechas, considera cancelar y crear uno nuevo.
</Warning>

## Cu√°ndo Cancelar un Cierre

Cancela un cierre en estas situaciones:

### 1. Cambio de Planes

**Escenario**: Planificaste vacaciones pero se cancelaron.

**Ejemplo**:
- Cierre creado: Vacaciones 1-15 agosto
- Situaci√≥n nueva: Viaje cancelado, cl√≠nica abrir√° normalmente
- Acci√≥n: Cancelar cierre para liberar disponibilidad

### 2. Error al Crear

**Escenario**: Creaste cierre con fechas incorrectas.

**Ejemplo**:
- Cierre creado: 1-15 agosto (15 d√≠as)
- Error: Deb√≠a ser 1-7 agosto (7 d√≠as)
- Acci√≥n: Cancelar cierre incorrecto, crear nuevo con fechas correctas

### 3. Proveedor Regresa Antes

**Escenario**: Proveedor plane√≥ permiso de 5 d√≠as pero regresa antes.

**Ejemplo**:
- Cierre creado: Dr. Garc√≠a, 3-7 febrero (5 d√≠as)
- Situaci√≥n nueva: Dr. Garc√≠a regresa el 5 febrero
- Acci√≥n: Cancelar cierre original, crear nuevo 3-4 febrero (2 d√≠as)

### 4. Cierre Ya No Necesario

**Escenario**: Cambios en la cl√≠nica hacen el cierre obsoleto.

**Ejemplo**:
- Cierre creado: Mantenimiento general, 10 febrero
- Situaci√≥n nueva: Mantenimiento pospuesto indefinidamente
- Acci√≥n: Cancelar cierre

## Pasos para Cancelar un Cierre

<Steps>
  <Step title="Navegar a lista de cierres">
    Desde el men√∫ principal, ve a:
    - **Gesti√≥n** ‚Üí **Cierres** ‚Üí **Todos los Cierres**

    O desde el Dashboard:
    - Click en widget "Pr√≥ximos Cierres" ‚Üí Ver cierre espec√≠fico

    O desde Upcoming Closures:
    - Dashboard ‚Üí Secci√≥n "Pr√≥ximos Cierres" ‚Üí Click en cierre
  </Step>

  <Step title="Buscar el cierre a cancelar">
    Usa los filtros disponibles para encontrar el cierre:

    **Filtro por fecha**:
    - Rango de fechas de inicio
    - Ejemplo: Mostrar cierres que empiezan en agosto

    **Filtro por tipo**:
    - Clinic-wide (toda la cl√≠nica)
    - Provider-specific (proveedor individual)

    **Filtro por proveedor**:
    - Selecciona proveedor del dropdown
    - Solo se muestran cierres de ese proveedor

    **B√∫squeda por raz√≥n**:
    - Busca por palabra clave en raz√≥n
    - Ejemplo: "Vacaciones"

    <Tip>
    Si el cierre est√° en los pr√≥ximos 14 d√≠as, aparecer√° en "Upcoming Closures" (m√°s f√°cil de encontrar).
    </Tip>
  </Step>

  <Step title="Click en 'Cancelar' o icono de eliminar">
    Una vez encontrado el cierre, tienes dos opciones:

    **Opci√≥n A: Desde la lista**:
    - Busca la columna "Acciones"
    - Click en icono de eliminar (üóëÔ∏è)

    **Opci√≥n B: Desde detalles del cierre**:
    - Click en el cierre para ver detalles
    - Bot√≥n "Cancelar Cierre" (rojo)
  </Step>

  <Step title="Confirmar cancelaci√≥n (modal)">
    El sistema mostrar√° un modal de confirmaci√≥n:

    **Mensaje**:
    ```
    ¬øEst√°s seguro de cancelar este cierre?

    Tipo: Clinic-wide
    Inicio: 2026-08-01 00:00
    Fin: 2026-08-15 23:59
    Raz√≥n: Vacaciones de verano

    ADVERTENCIA: Esta acci√≥n es irreversible.
    Los slots bloqueados se liberar√°n inmediatamente.
    ```

    **Opciones**:
    - **Cancelar Cierre** (rojo): Proceder con eliminaci√≥n
    - **Volver** (gris): Abortar, no cancelar

    <Warning>
    Lee cuidadosamente los detalles antes de confirmar. Una vez cancelado, NO se puede recuperar.
    </Warning>
  </Step>

  <Step title="Cierre se elimina">
    Al confirmar, el sistema ejecutar√°:

    1. Validaci√≥n de permisos (solo ADMIN/CLINIC_ADMIN pueden cancelar)
    2. Eliminaci√≥n del cierre de la base de datos (DELETE, no soft delete)
    3. Cancelaci√≥n de jobs din√°micos (`scheduler.remove_job()`)
    4. Invalidaci√≥n de cache de disponibilidad
    5. **Si cierre estaba activo**: Emisi√≥n de evento WebSocket `clinic_status_changed`
    6. Slots liberados inmediatamente

    **Mensaje de confirmaci√≥n**:
    ```
    Cierre cancelado exitosamente.
    Disponibilidad actualizada.
    ```
  </Step>
</Steps>

## Resultado de Cancelar un Cierre

Despu√©s de cancelar, el sistema habr√° realizado:

### 1. Cierre Eliminado de Base de Datos

El cierre se elimina completamente del sistema:

**Resultado**:
- El cierre desaparece de la lista de cierres activos
- Las citas previamente bloqueadas vuelven a estar disponibles para agendar
- El cierre NO se puede recuperar (eliminaci√≥n permanente)

<Note>
**Eliminaci√≥n permanente**: A diferencia de las citas (que se marcan como canceladas), los cierres se eliminan completamente. Esto simplifica la gesti√≥n y evita confusiones con cierres pasados.
</Note>

### 2. Jobs Din√°micos Cancelados

APScheduler elimina autom√°ticamente los 2 jobs asociados:

**Jobs eliminados**:
- `closure_abc_start` (DateTrigger para inicio)
- `closure_abc_end` (DateTrigger para fin)

**Verificaci√≥n**:
```python
# Endpoint: GET /system/scheduler/status
# Resultado: Los jobs closure_abc_* ya NO aparecen en la lista
```

<Tip>
Puedes verificar que los jobs fueron cancelados en el endpoint de administraci√≥n `/system/scheduler/status` (requiere permisos admin).
</Tip>

### 3. Availability Cache Invalidated

El sistema invalida toda la cache de disponibilidad:

**Caches afectadas**:
- `get_availability` (TTL 3 min) ‚Üí Invalidada ‚úÖ
- `OperationalStatusService` (TTL 30 seg) ‚Üí Invalidada ‚úÖ
- `ConfigurationStatusService` (TTL 5 min) ‚Üí Invalidada ‚úÖ

**Resultado**: Las pr√≥ximas consultas de disponibilidad NO considerar√°n el cierre cancelado.

### 4. WebSocket Event Emitido (si cierre estaba activo)

**Solo si el cierre YA hab√≠a empezado** (cuando `starts_at` es menor o igual a la hora actual):

El sistema emite evento WebSocket inmediatamente:

```json
{
  "event": "clinic_status_changed",
  "data": {
    "status": "open",
    "clinic_id": "abc-123",
    "reason": "Cierre cancelado: Vacaciones de verano"
  }
}
```

**Impacto**:
- Frontends conectados actualizan interfaces autom√°ticamente
- Widget de status cambia de "Cerrado" a "Abierto"
- No requiere refresh manual

<Note>
Si el cierre NO hab√≠a empezado a√∫n (starts_at > now), NO se emite evento WebSocket porque el status operacional no cambia (la cl√≠nica ya estaba abierta).
</Note>

### 5. Slots Liberados Inmediatamente

Los slots bloqueados por el cierre vuelven a estar disponibles:

**Ejemplo**:

**Antes de cancelar**:
```
Per√≠odo: 1-15 agosto
Slots bloqueados: 300 slots
Slots disponibles: 0 slots
```

**Despu√©s de cancelar**:
```
Per√≠odo: 1-15 agosto
Slots bloqueados: 0 slots
Slots disponibles: 300 slots ‚úÖ
```

**Validaci√≥n**:
- Llama a `GET /v1/availability?date=2026-08-01`
- Resultado: Slots aparecen disponibles inmediatamente

### 6. Upcoming Closure Eliminado (si aplicaba)

Si el cierre estaba en upcoming closures (pr√≥ximos 14 d√≠as):

**Antes**:
```json
{
  "upcoming_closures": [
    {
      "id": "abc-123",
      "starts_at": "2026-08-01T00:00:00Z",
      "days_until_start": 7
    }
  ]
}
```

**Despu√©s**:
```json
{
  "upcoming_closures": []
}
```

## Ejemplos de Cancelaci√≥n

<AccordionGroup>
  <Accordion title="Ejemplo 1: Vacaciones canceladas (clinic-wide)">
    **Escenario**: Vacaciones planificadas fueron canceladas.

    **Cierre original**:
    - Tipo: Clinic-wide
    - Inicio: `2026-08-01 00:00`
    - Fin: `2026-08-15 23:59`
    - Raz√≥n: "Vacaciones de verano"
    - Slots bloqueados: 300 slots (100% - impacto HIGH)

    **Situaci√≥n nueva**: Viaje cancelado, cl√≠nica abrir√° normalmente.

    **Proceso de cancelaci√≥n**:
    1. Navegar a Upcoming Closures (cierre aparece con countdown "7 d√≠as")
    2. Click en icono eliminar (üóëÔ∏è)
    3. Confirmar cancelaci√≥n en modal
    4. Sistema elimina cierre
    5. Jobs cancelados: `closure_abc_start`, `closure_abc_end`
    6. Cache invalidada ‚úÖ
    7. 300 slots liberados ‚úÖ

    **Resultado**:
    - Disponibilidad 1-15 agosto restaurada
    - Clientes pueden agendar citas para esas fechas
    - Upcoming closure ya NO aparece
  </Accordion>

  <Accordion title="Ejemplo 2: Fechas incorrectas (provider-specific)">
    **Escenario**: Creaste cierre con fechas incorrectas.

    **Cierre original** (ERROR):
    - Tipo: Provider-specific (Dr. Garc√≠a)
    - Inicio: `2026-02-01 00:00`
    - Fin: `2026-02-15 23:59` (15 d√≠as - INCORRECTO)
    - Raz√≥n: "Permiso m√©dico"

    **Correcto**: Deb√≠a ser 1-7 febrero (7 d√≠as).

    **Proceso de correcci√≥n**:
    1. Cancelar cierre incorrecto (1-15 febrero)
       - Navegar a lista de cierres
       - Buscar cierre del Dr. Garc√≠a
       - Click en eliminar
       - Confirmar
    2. Crear nuevo cierre correcto (1-7 febrero)
       - Tipo: Provider-specific (Dr. Garc√≠a)
       - Inicio: `2026-02-01 00:00`
       - Fin: `2026-02-07 23:59` (7 d√≠as - CORRECTO)
       - Raz√≥n: "Permiso m√©dico"

    **Resultado**:
    - Cierre incorrecto eliminado ‚úÖ
    - Cierre correcto creado ‚úÖ
    - Disponibilidad 8-15 febrero restaurada (Dr. Garc√≠a disponible) ‚úÖ
  </Accordion>

  <Accordion title="Ejemplo 3: Proveedor regresa antes (ajuste de fechas)">
    **Escenario**: Proveedor plane√≥ 5 d√≠as de permiso pero regresa antes.

    **Cierre original**:
    - Tipo: Provider-specific (Dra. L√≥pez)
    - Inicio: `2026-03-10 00:00`
    - Fin: `2026-03-14 23:59` (5 d√≠as)
    - Raz√≥n: "Capacitaci√≥n externa"

    **Situaci√≥n nueva**: Dra. L√≥pez regresa el 12 de marzo (solo 2 d√≠as).

    **Proceso de ajuste**:
    1. Cancelar cierre original (10-14 marzo)
    2. Crear nuevo cierre (10-11 marzo)
       - Tipo: Provider-specific (Dra. L√≥pez)
       - Inicio: `2026-03-10 00:00`
       - Fin: `2026-03-11 23:59` (2 d√≠as)
       - Raz√≥n: "Capacitaci√≥n externa (ajustado)"

    **Resultado**:
    - Dra. L√≥pez bloqueada solo 10-11 marzo ‚úÖ
    - Disponible 12-14 marzo (liberado) ‚úÖ
    - Clientes pueden agendar con ella 12-14 marzo
  </Accordion>

  <Accordion title="Ejemplo 4: Cierre activo (ya empez√≥)">
    **Escenario**: Cierre ya empez√≥ pero se cancela prematuramente.

    **Cierre original**:
    - Tipo: Clinic-wide
    - Inicio: `2026-07-01 00:00` (hace 2 d√≠as)
    - Fin: `2026-07-05 23:59` (faltan 3 d√≠as)
    - Raz√≥n: "Mantenimiento el√©ctrico"

    **Situaci√≥n nueva**: Mantenimiento se complet√≥ antes de lo esperado.

    **Proceso de cancelaci√≥n**:
    1. Navegar a lista de cierres ‚Üí Filtrar "Cierres activos"
    2. Buscar cierre de mantenimiento
    3. Click en eliminar
    4. Confirmar cancelaci√≥n

    **Resultado**:
    1. Cierre eliminado ‚úÖ
    2. Jobs cancelados ‚úÖ
    3. **WebSocket emitido** ‚úÖ (porque cierre estaba activo):
       ```json
       {
         "event": "clinic_status_changed",
         "data": {
           "status": "open",
           "clinic_id": "abc-123",
           "reason": "Mantenimiento completado antes de lo esperado"
         }
       }
       ```
    4. Frontend actualiza status: "Cerrado" ‚Üí "Abierto" (sin refresh)
    5. Disponibilidad 3-5 julio liberada ‚úÖ

    **Impacto**: Cl√≠nica puede empezar a atender pacientes inmediatamente (3-5 julio).
  </Accordion>
</AccordionGroup>

## Validaciones y Errores Comunes

<AccordionGroup>
  <Accordion title="Error 403: Cannot manage this clinic">
    **Problema**: No tienes permisos para cancelar cierres.

    **Causa**: Solo usuarios con rol ADMIN o CLINIC_ADMIN pueden cancelar cierres.

    **Soluci√≥n**:
    - Verifica tu rol en la secci√≥n de perfil
    - Solicita permisos de administrador a un admin existente
    - Si eres admin, verifica que est√°s autenticado correctamente

    **Verificaci√≥n de permisos**:

    Endpoint: `GET /v1/users/me`

    Respuesta:
    ```json
    {
      "role": "CLINIC_ADMIN",
      "clinic_id": "abc-123"
    }
    ```

    <Note>
    El role debe ser ADMIN o CLINIC_ADMIN para poder cancelar cierres.
    </Note>
  </Accordion>

  <Accordion title="Error 404: Closure not found">
    **Problema**: El cierre que intentas cancelar no existe.

    **Causas posibles**:

    **1. Cierre ya fue cancelado**:
    - Otro usuario cancel√≥ el cierre antes que t√∫
    - Soluci√≥n: Refrescar la lista de cierres

    **2. ID incorrecto**:
    - Copiaste mal el ID del cierre
    - Soluci√≥n: Verificar ID en la URL o lista

    **3. Cierre pertenece a otra cl√≠nica**:
    - Est√°s intentando cancelar un cierre de otra cl√≠nica
    - Soluci√≥n: Verificar clinic_id en los filtros
  </Accordion>

  <Accordion title="Error 500: Failed to cancel jobs">
    **Problema**: Error al cancelar los jobs din√°micos en APScheduler.

    **Causa**: Problema con APScheduler (poco com√∫n).

    **Impacto**:
    - El cierre SE elimina de la base de datos ‚úÖ
    - Los jobs PUEDEN seguir en el scheduler ‚ùå

    **Soluci√≥n**:
    1. Reportar a soporte con detalles:
       - ID del cierre
       - Timestamp del error
       - Logs del servidor
    2. Temporary workaround: Admin puede cancelar jobs manualmente:
       ```
       POST /system/scheduler/jobs/closure_abc_start/cancel
       POST /system/scheduler/jobs/closure_abc_end/cancel
       ```
  </Accordion>

  <Accordion title="No puedo cancelar cierre (bot√≥n deshabilitado)">
    **Problema**: El bot√≥n "Cancelar" est√° deshabilitado o no aparece.

    **Causas posibles**:

    **1. Cierre ya pas√≥**:
    - Si `ends_at < now`, el cierre ya finaliz√≥
    - No tiene sentido cancelarlo (ya no est√° activo)
    - Soluci√≥n: Los cierres pasados no se pueden cancelar

    **2. Permisos insuficientes**:
    - Solo ADMIN/CLINIC_ADMIN ven el bot√≥n
    - Soluci√≥n: Solicitar permisos

    **3. Cierre est√° en proceso de eliminaci√≥n**:
    - Otro usuario est√° cancel√°ndolo en este momento
    - Soluci√≥n: Esperar unos segundos, refrescar
  </Accordion>
</AccordionGroup>

## Advertencias Importantes

<Warning>
**Cancelaci√≥n es irreversible**:

Una vez cancelado, el cierre se elimina permanentemente. NO existe funcionalidad de "recuperar cierre cancelado".

Si cancelas por error:
- Debes crear un nuevo cierre con los mismos datos
- No hay forma de recuperar el ID original
- Los jobs se registrar√°n con nuevos IDs
</Warning>

<Warning>
**Citas existentes NO se afectan**:

Cancelar un cierre NO cancela autom√°ticamente citas que ya fueron agendadas en ese per√≠odo.

**Escenario**:
1. Creas cierre 1-15 agosto
2. Sistema bloquea nuevas citas
3. Cancelas cierre el 25 de julio
4. Slots se liberan PARA NUEVAS CITAS ‚úÖ
5. Citas ya existentes (si las hay) NO se cancelan ‚ùå

**Implicaci√≥n**: Si quieres liberar disponibilidad completa, debes cancelar manualmente citas existentes en ese per√≠odo.
</Warning>

<Tip>
**Usa preview de impacto antes de cancelar**:

Antes de cancelar un cierre:
1. Click en "Ver Impacto" en detalles del cierre
2. Revisa cu√°ntos slots se liberar√°n
3. Valida que la cancelaci√≥n es correcta

Esto previene cancelaciones accidentales.
</Tip>

<Note>
**Cancelar vs Modificar fechas**:

El sistema NO soporta modificar fechas de un cierre existente. Si necesitas cambiar fechas:
1. Cancelar cierre original
2. Crear nuevo cierre con fechas correctas

Esto es intencional para simplificar la l√≥gica y evitar bugs con jobs din√°micos.
</Note>

## Diferencia: Cancelar Cierre vs Crear Cierre Nuevo

### Cancelar Cierre (DELETE)

**Objetivo**: Eliminar un cierre existente que ya no es necesario.

**Resultado**:
- Cierre eliminado de DB ‚úÖ
- Jobs cancelados ‚úÖ
- Slots liberados ‚úÖ
- NO requiere crear nuevo

**Cu√°ndo usar**:
- Cambio de planes (vacaciones canceladas)
- Error al crear
- Cierre ya no necesario

### Crear Cierre Nuevo con Fechas Diferentes

**Objetivo**: Reemplazar un cierre con fechas ajustadas.

**Resultado**:
- Cierre original sigue existiendo ‚ùå
- Cierre nuevo creado ‚úÖ
- **Problema**: Dos cierres solapados pueden causar confusi√≥n

**Cu√°ndo NO usar**:
- NO uses para "modificar" un cierre
- Primero cancela, LUEGO crea nuevo

**Flujo correcto**:
1. Cancelar cierre original
2. Crear nuevo cierre con fechas correctas
3. Evitas duplicaci√≥n y confusi√≥n

## Pr√≥ximos Pasos

<CardGroup cols={2}>
  <Card title="Crear Cierre" icon="calendar-plus" href="/closures/create-closure">
    Crear nuevo cierre despu√©s de cancelar
  </Card>

  <Card title="Preview de Impacto" icon="chart-mixed" href="/closures/impact-preview">
    Verificar impacto antes de cancelar
  </Card>

  <Card title="Ver Upcoming Closures" icon="calendar-clock" href="/closures/view-upcoming">
    Revisar cierres pr√≥ximos a cancelar
  </Card>

  <Card title="Volver a Overview" icon="arrow-left" href="/closures/overview">
    Conceptos generales de cierres
  </Card>
</CardGroup>
