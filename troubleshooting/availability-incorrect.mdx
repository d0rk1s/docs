---
title: 'Availability Incorrect'
description: 'Comprehensive troubleshooting guide for availability calculation issues'
icon: 'calendar-circle-exclamation'
---

<Warning>
Availability calculation is complex - it depends on work hours (clinic + provider), closures, appointments, resources, and subscription limits. Follow this systematic debugging guide.
</Warning>

<Frame>
  <img src="/images/screenshots/troubleshooting_no_availability.png" alt="Error de disponibilidad mostrando 'No hay horarios disponibles' con guía de diagnóstico" />
</Frame>

## Quick Diagnosis Checklist

Before detailed troubleshooting, verify these 7 critical factors:

<Steps>
  <Step title="Work hours configured (clinic-level)">
    Go to **Configuration** → **Work Hours** → **Clinic Hours** and verify hours exist for the target weekday.
  </Step>
  <Step title="Work hours configured (provider-level)">
    Go to **Providers** → Select provider → **Work Hours** and verify provider has hours for the target weekday.
  </Step>
  <Step title="No active closures">
    Go to **Closures** and verify no closures overlap with the target date.
  </Step>
  <Step title="Subscription limit not reached">
    Go to **Settings** → **Subscription** and check appointments used vs limit.
  </Step>
  <Step title="Service duration valid">
    Verify service duration + buffer fits within work hours.
  </Step>
  <Step title="Resources available (if required)">
    If service requires resources, check **Resources** availability.
  </Step>
  <Step title="Cache invalidated">
    Wait 3 minutes (cache TTL) or force refresh by clicking **Refresh** button.
  </Step>
</Steps>

## Common Availability Issues

<AccordionGroup>
  <Accordion title="No slots shown even though clinic is open" icon="calendar-xmark">
    **Symptom**: Calendar shows "No available slots" but clinic should be open.

    **Diagnosis Flowchart**:

    ```
    No slots shown
    ├─ Work hours missing? ────────→ Configure work hours
    ├─ Closure active? ────────────→ Remove or reschedule closure
    ├─ All slots booked? ──────────→ Wait for cancellations or add provider
    ├─ Subscription limit? ────────→ Upgrade plan or enable overage
    ├─ Resource conflict? ─────────→ Add resources or remove requirement
    └─ Cache stale? ───────────────→ Wait 3 min or force refresh
    ```

    **Debugging Steps**:
    <Steps>
      <Step title="Verify clinic-level work hours">
        ```sql
        -- In database:
        SELECT weekday, open_time, close_time
        FROM work_hours
        WHERE clinic_id = 'your-clinic-id'
          AND provider_id IS NULL
        ORDER BY weekday, open_time;

        -- Expected: At least one row per working weekday (1=Monday, 7=Sunday)
        ```

        If empty, clinic has NO work hours configured. Go to **Configuration** → **Work Hours** and add hours.
      </Step>
      <Step title="Verify provider-level work hours">
        ```sql
        -- In database:
        SELECT p.full_name, w.weekday, w.open_time, w.close_time
        FROM work_hours w
        JOIN providers p ON w.provider_id = p.id
        WHERE w.clinic_id = 'your-clinic-id'
        ORDER BY p.full_name, w.weekday, w.open_time;

        -- Expected: Hours for each provider
        ```

        If empty, providers have NO work hours. Configure in **Providers** → **Work Hours**.
      </Step>
      <Step title="Check for active closures">
        ```sql
        -- In database:
        SELECT starts_at, ends_at, reason
        FROM closures
        WHERE clinic_id = 'your-clinic-id'
          AND starts_at <= 'target-date'
          AND ends_at >= 'target-date';

        -- If rows exist, closure is blocking availability
        ```

        Delete or reschedule closure in **Closures** page.
      </Step>
      <Step title="Verify subscription limits">
        ```bash
        python scripts/check_subscription_limit.py --clinic-id <uuid>

        # Shows: Plan, Used, Limit, Overage enabled
        ```

        If limit reached and overage disabled, upgrade plan or enable overage.
      </Step>
      <Step title="Check resource availability">
        If service requires resources:
        ```sql
        SELECT r.name, r.is_active
        FROM resources r
        JOIN service_resource_requirements srr ON r.id = srr.resource_id
        WHERE srr.service_id = 'service-id';

        -- All resources must be is_active = TRUE
        ```
      </Step>
      <Step title="Invalidate cache manually">
        ```bash
        # In backend:
        curl -X POST http://localhost:8000/v1/cache/invalidate \
          -H "Authorization: Bearer <token>" \
          -d '{"clinic_id": "your-clinic-id"}'
        ```

        Or wait 3 minutes (cache TTL).
      </Step>
    </Steps>

    <Warning>
    **Work Hours Hierarchy**: Clinic hours define operational window. Provider hours must INTERSECT with clinic hours. If clinic is closed (no clinic-level work_hours), NO appointments allowed regardless of provider availability.
    </Warning>
  </Accordion>

  <Accordion title="Slots shown at wrong times (timezone issue)" icon="clock">
    **Symptom**: Available slots show at odd times like 15:35, 16:05 instead of 15:00, 16:00.

    **Diagnosis**: This was a bug fixed in 2025-11-19 (Slot Alignment Fix). If you see this symptom on recent versions, it's a regression.

    **Expected Behavior**:
    - Clinic opens at 16:00 → First slot should be 16:00 (not 16:35)
    - Service duration 30min → Slots: 16:00, 16:30, 17:00 (aligned)

    **Actual Behavior (bug)**:
    - User queries at 15:35 → System generates slots: 16:35, 17:05, 17:35 (WRONG)

    **Validation**:
    <Steps>
      <Step title="Check slot alignment">
        ```bash
        python scripts/test_slot_alignment_fix.py

        # Should output:
        # ✅ Slots aligned with clinic opening hours
        # ❌ Slots misaligned (bug regression)
        ```
      </Step>
      <Step title="Verify work_start adjustment">
        ```python
        # In app/services/availability_service_v2.py (line ~323)
        # CORRECT (after fix):
        work_start = work_start  # Keep original clinic opening time

        # WRONG (bug):
        if now > work_start:
            work_start = now  # REMOVED - causes misalignment
        ```
      </Step>
      <Step title="Check generated slots">
        Enable verbose logging:
        ```python
        # In app/utils/time_slots.py
        logger.info(f"Generated slots: {slots}")
        ```

        Should show slots aligned with clinic hours: `16:00:00+01:00`, `16:30:00+01:00` (not `16:35:00+01:00`).
      </Step>
    </Steps>

    **Fix**: Ensure `get_available_slots()` does NOT prematurely adjust `work_start` to current time. Let `generate_time_slots_dynamic()` handle filtering via `now_limit`.

    See `docs/FIX_SLOT_ALIGNMENT_BUG.md` for full details.
  </Accordion>

  <Accordion title="Clinic closed but slots still showing (provider override bug)" icon="door-closed">
    **Symptom**: Clinic is closed (e.g., Saturday, Sunday) but system shows available slots because provider has work hours configured.

    **Diagnosis**: This was a critical bug fixed in 2025-11-16 (Clinic Closed But Provider Available Fix).

    **Business Rule**: If clinic is closed (no clinic-level work_hours for weekday), NO appointments allowed regardless of provider availability.

    **Example**:
    - Clinic closed on Saturday (no work_hours for weekday=6)
    - "Peluquero 2" works 09:00-22:00 on Saturday
    - System showed 26 slots ❌ WRONG
    - Expected: 0 slots ✅ CORRECT

    **Validation**:
    <Steps>
      <Step title="Check clinic hours for weekday">
        ```sql
        SELECT open_time, close_time
        FROM work_hours
        WHERE clinic_id = 'your-clinic-id'
          AND provider_id IS NULL
          AND weekday = 6;  -- Saturday

        -- If empty, clinic is CLOSED on Saturday
        ```
      </Step>
      <Step title="Check provider hours (should be ignored)">
        ```sql
        SELECT p.full_name, w.open_time, w.close_time
        FROM work_hours w
        JOIN providers p ON w.provider_id = p.id
        WHERE w.clinic_id = 'your-clinic-id'
          AND w.weekday = 6;

        -- Even if rows exist, they should be IGNORED if clinic is closed
        ```
      </Step>
      <Step title="Verify fix is applied">
        ```python
        # In app/services/availability_service_v2.py
        # Method: _get_provider_work_hours_for_date (line ~915)

        # CORRECT (after fix):
        clinic_periods = self._get_work_hours_for_date(...)
        if not clinic_periods:
            return []  # Clinic closed → No provider hours

        # WRONG (bug):
        # No check for clinic_periods → Provider hours returned even if clinic closed
        ```
      </Step>
    </Steps>

    **Fix**: `_get_provider_work_hours_for_date()` now validates clinic is open BEFORE calculating provider availability.

    See `docs/FIX_CLINIC_CLOSED_PROVIDER_AVAILABLE_BUG.md` for full details.
  </Accordion>

  <Accordion title="Slots shown in UTC instead of local time" icon="globe">
    **Symptom**: Available slots show UTC timezone (`19:10:00+00:00`) but should show local time (`20:10:00+01:00` for Madrid).

    **Diagnosis**: This was a critical bug fixed in 2025-11-05 (Timezone Conversion Fix).

    **Architecture**: System uses UTC internally but MUST convert to local timezone before sending to LLM/frontend.

    **Validation**:
    <Steps>
      <Step title="Check availability response">
        ```bash
        curl -X GET "http://localhost:8000/v1/availability?clinic_id=<id>&date=2025-11-20" \
          -H "Authorization: Bearer <token>"

        # Response should show local timezone:
        # "20:10:00+01:00" ✅ (Madrid local time)
        # NOT "19:10:00+00:00" ❌ (UTC)
        ```
      </Step>
      <Step title="Verify timezone conversion in code">
        ```python
        # In app/services/appointment_orchestrator.py (line ~88)
        # CORRECT (after fix):
        slots = [s.astimezone(clinic_tz) for s in slots]

        # WRONG (bug):
        # No timezone conversion → UTC sent to LLM
        ```
      </Step>
      <Step title="Test with script">
        ```bash
        python scripts/test_timezone_fix.py <clinic_id>

        # Should output:
        # ✅ Slots in local timezone: 2025-11-20 20:10:00+01:00
        # ❌ Slots in UTC (bug): 2025-11-20 19:10:00+00:00
        ```
      </Step>
    </Steps>

    **Fix**: `get_availability()` now converts slots to local timezone before returning to LLM/frontend.

    See `docs/FIX_TIMEZONE_CONVERSION_BUG.md` for full details.
  </Accordion>

  <Accordion title="Work hours overlap error when saving" icon="clock-rotate-left">
    **Symptom**: Cannot save work hours with error "Work hours overlap for this day".

    **Diagnosis**: Two periods overlap. Database validates via `app/services/work_hours_validator.py`.

    **Overlap Logic**:
    ```
    Two periods overlap if: A_start < B_end AND B_start < A_end

    Examples:
    ❌ Period A: 09:00-14:00, Period B: 13:00-17:00 → OVERLAP (13:00-14:00)
    ✅ Period A: 09:00-13:00, Period B: 13:00-17:00 → CONTIGUOUS (no overlap)
    ✅ Period A: 09:00-13:00, Period B: 15:00-19:00 → GAP (no overlap)
    ```

    **Debugging Steps**:
    <Steps>
      <Step title="List all periods for weekday">
        ```sql
        SELECT open_time, close_time
        FROM work_hours
        WHERE clinic_id = 'your-clinic-id'
          AND provider_id IS NULL  -- or provider_id = 'provider-id'
          AND weekday = 1  -- Monday
        ORDER BY open_time;

        -- Check for overlaps manually
        ```
      </Step>
      <Step title="Delete conflicting period">
        If editing, delete the existing period first, then create new one:
        ```bash
        DELETE FROM work_hours WHERE id = 'work-hour-id';
        ```
      </Step>
      <Step title="Use contiguous times">
        If you want back-to-back periods (no gap), use same time for end/start:
        - Period A: 09:00-13:00
        - Period B: 13:00-17:00 ✅ (allowed)
      </Step>
    </Steps>

    <Info>
    Multiple non-contiguous periods per day are supported (e.g., morning 09:00-13:00 + afternoon 15:00-19:00). This is useful for split shifts.
    </Info>
  </Accordion>

  <Accordion title="Slots shown during lunch break (gap not respected)" icon="burger-soda">
    **Symptom**: System shows slots at 13:30, 14:00 but clinic has lunch break 13:00-15:00.

    **Diagnosis**: Missing work hours configuration for split shift.

    **Correct Configuration**:
    - Morning: 09:00-13:00
    - Afternoon: 15:00-19:00
    - Gap: 13:00-15:00 (NO work hours entry)

    **Debugging Steps**:
    <Steps>
      <Step title="Verify split shift configuration">
        ```sql
        SELECT open_time, close_time
        FROM work_hours
        WHERE clinic_id = 'your-clinic-id'
          AND provider_id IS NULL
          AND weekday = 1  -- Monday
        ORDER BY open_time;

        -- Expected:
        -- 09:00:00, 13:00:00
        -- 15:00:00, 19:00:00

        -- WRONG:
        -- 09:00:00, 19:00:00 (continuous, no gap)
        ```
      </Step>
      <Step title="Delete continuous period">
        If you have 09:00-19:00, delete it:
        ```bash
        DELETE FROM work_hours WHERE id = 'work-hour-id';
        ```
      </Step>
      <Step title="Create two separate periods">
        1. Morning: 09:00-13:00
        2. Afternoon: 15:00-19:00

        Gap 13:00-15:00 has NO entry → No slots generated.
      </Step>
    </Steps>

    <Info>
    The system automatically handles multiple periods. Slots are generated ONLY within valid periods, NOT in gaps.
    </Info>
  </Accordion>

  <Accordion title="Buffer preventing valid slots" icon="arrows-left-right">
    **Symptom**: Service duration is 30min, slot at 13:30 exists, but system says "not available" because buffer_before=15min and next appointment is at 14:00.

    **Diagnosis**: Buffer logic is working correctly. This is EXPECTED behavior.

    **Buffer Logic**:
    - `buffer_before_min`: Minutes required before appointments
    - `buffer_before_only=True`: Only apply buffer when free period ends immediately before busy period

    **Example**:
    - Service duration: 30min
    - Buffer before: 15min
    - Slot at 13:30
    - Next appointment: 14:00
    - Required: 13:30 + 30min (service) + 15min (buffer) = 14:15
    - Available until: 14:00
    - Result: Slot BLOCKED ✅ (correct)

    **Solution**:
    <Steps>
      <Step title="Reduce buffer_before_min">
        If buffers are too aggressive, reduce in **Services** → Edit service → **Buffer Before**.
      </Step>
      <Step title="Disable buffer_before_only">
        If you want buffer to always apply (even when no next appointment), set `buffer_before_only=False`.
      </Step>
      <Step title="Adjust service duration">
        If service consistently needs more time, increase duration instead of using buffers.
      </Step>
    </Steps>

    <Warning>
    Buffers exist to prevent back-to-back appointments with no preparation time. Disabling them may cause operational issues (providers rushing between clients).
    </Warning>
  </Accordion>

  <Accordion title="Cache showing stale availability" icon="arrows-rotate">
    **Symptom**: Created appointment 2 minutes ago but availability still shows the booked slot.

    **Diagnosis**: Cache has 3-minute TTL. Wait up to 3 minutes or force invalidation.

    **Cache Strategy**:
    - `get_availability`: 3 min TTL (180s)
    - `get_patient_appointments`: 5 min TTL (300s)
    - Automatic invalidation on create/cancel/reschedule

    **Debugging Steps**:
    <Steps>
      <Step title="Wait 3 minutes">
        Cache expires automatically. Refresh page after 3 minutes.
      </Step>
      <Step title="Force refresh">
        Click **Refresh** button (triggers new cache entry).
      </Step>
      <Step title="Verify cache invalidation">
        ```bash
        # In backend logs:
        grep "invalidate_availability_cache" logs/app.log

        # Should show invalidation after appointment creation
        ```
      </Step>
      <Step title="Check cache TTL">
        ```python
        # In app/services/clinic_agent/tools/cache.py
        # Verify TTL is not too high:
        "get_availability": 180,  # 3 minutes
        ```
      </Step>
    </Steps>

    <Info>
    Cache invalidation is automatic. You should NOT need to manually invalidate unless testing/debugging.
    </Info>
  </Accordion>
</AccordionGroup>

## Debugging Tools and Scripts

### Test Slot Alignment

Verify slots are aligned with clinic opening hours:

```bash
python scripts/test_slot_alignment_fix.py

# Expected output:
# ✅ Clinic opens at 16:00
# ✅ First slot: 16:00:00+01:00 (aligned)
# ✅ Service duration: 30min
# ✅ Slots: 16:00, 16:30, 17:00, 17:30, ... (aligned)
```

### Debug Timezone Conversion

Check if slots are in correct timezone:

```bash
python scripts/test_timezone_fix.py <clinic_id>

# Expected output:
# ✅ Slots in local timezone: 2025-11-20 20:10:00+01:00
# ❌ Bug detected: Slots in UTC: 2025-11-20 19:10:00+00:00
```

### Check Subscription Limits

Verify plan limits and usage:

```bash
python scripts/check_subscription_limit.py --clinic-id <uuid>

# Output:
# Plan: STARTER
# Limit: 50 appointments/month
# Used: 32 appointments
# Remaining: 18 appointments
# Overage enabled: False
```

### Analyze Availability Query

Deep debugging of availability calculation:

```bash
# Enable verbose logging in backend:
export LOG_LEVEL=DEBUG

# In logs, search for:
grep "calculate_availability" logs/app.log

# Shows:
# - Work hours fetched (clinic + provider)
# - Closures applied
# - Appointments filtered
# - Slots generated
# - Final availability
```

## Architecture Notes

### Work Hours Hierarchy

```
Clinic Hours (Operational Window)
    ├─ Provider A Hours (Intersection)
    ├─ Provider B Hours (Intersection)
    └─ Provider C Hours (Intersection)

Rule: If clinic is closed (no clinic-level work_hours), NO appointments allowed.
```

**Example**:
- Clinic hours: 08:00-20:00 (Monday-Friday)
- Provider A: 09:00-17:00 (Intersection → 09:00-17:00)
- Provider B: 07:00-15:00 (Intersection → 08:00-15:00, NOT 07:00-08:00)
- Saturday: Clinic closed → Provider hours IGNORED

### Availability Calculation Flow

```
1. Fetch clinic work hours for date
   ↓
2. Fetch provider work hours for date
   ↓
3. Calculate intersection (clinic ∩ provider)
   ↓
4. Generate time slots within intersection
   ↓
5. Filter conflicts (appointments, closures, resources)
   ↓
6. Apply buffers (buffer_before, buffer_after)
   ↓
7. Return available slots
```

### Cache Invalidation Events

Availability cache is invalidated when:
- Appointment created
- Appointment cancelled
- Appointment rescheduled
- Work hours updated (clinic or provider)
- Closure created/deleted
- Resource availability changed

## Historical Fixes

<AccordionGroup>
  <Accordion title="Fix: Timezone conversion bug (2025-11-05)" icon="clock">
    **Problem**: LLM received slots in UTC but interpreted as local time → 1-hour offset.

    **Fix**: `get_availability()` converts to local timezone before sending to LLM.

    **Files**: `app/services/appointment_orchestrator.py` (line ~88)

    **Documentation**: `docs/FIX_TIMEZONE_CONVERSION_BUG.md`
  </Accordion>

  <Accordion title="Fix: Clinic closed but provider available (2025-11-16)" icon="door-closed">
    **Problem**: System showed slots when clinic was closed but provider had work hours.

    **Fix**: `_get_provider_work_hours_for_date()` validates clinic is open BEFORE calculating provider availability.

    **Files**: `app/services/availability_service_v2.py` (lines ~915-1010)

    **Documentation**: `docs/FIX_CLINIC_CLOSED_PROVIDER_AVAILABLE_BUG.md`
  </Accordion>

  <Accordion title="Fix: Slot alignment bug (2025-11-19)" icon="align-left">
    **Problem**: Slots generated at odd times (16:35, 17:05) instead of aligned times (16:00, 16:30).

    **Fix**: Removed premature adjustment of `work_start` to current time in `get_available_slots()`.

    **Files**: `app/services/availability_service_v2.py` (lines ~323-340)

    **Documentation**: `docs/FIX_SLOT_ALIGNMENT_BUG.md`
  </Accordion>
</AccordionGroup>

## Still Having Issues?

<Card title="Contact Support" icon="headset" href="/troubleshooting/contact-support">
  If availability is still incorrect after trying all debugging steps, contact support with:
  - Clinic ID
  - Target date and time
  - Expected slots vs actual slots
  - Screenshots of work hours configuration
  - Database export of work_hours and closures for target date
  - Backend logs (grep "calculate_availability")
</Card>

<Tip>
**Quick fixes to try first**:
1. Wait 3 minutes (cache expiration)
2. Click **Refresh** button (force new cache)
3. Verify work hours exist for both clinic AND provider
4. Check for active closures on target date
5. Verify subscription limit not reached
</Tip>
